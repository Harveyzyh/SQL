-- 领料单
SELECT ML005, TC009, TE004, MB002, TE010, TE008, SL 
-- UPDATE INVML SET ML005 = SL
FROM INVML(NOLOCK)
LEFT JOIN(
	SELECT TC009, TE004, MB002, TE010, TE008, SUM(TE005) SL FROM MOCTE 
	INNER JOIN MOCTC ON TC001 = TE001 AND TE002 = TC002 
	INNER JOIN INVMB ON MB001 = TE004
	WHERE 1=1
	AND TC009 = 'N'
	AND TC001+'-'+RTRIM(TC002) IN ('5406-2020050076')
	GROUP BY TC009, TE004, MB002, TE010, TE008
) AS A ON TE004 = ML001 AND ML002 = TE008 AND TE010 = ML004
WHERE 1=1
AND TE004 IS NOT NULL
AND SL > ML005
ORDER BY TE004



-- 库存交易单
SELECT ML005, A.TA006, A.TB004, MB002, A.TB014, A.TB012, A.TB013, SL 
-- UPDATE INVML SET ML005 = SL
FROM INVML(NOLOCK) 
INNER JOIN (
	SELECT TA006, TB004, MB002, TB014, TB012, TB013, SUM(TB007) SL
	FROM INVTA 
	INNER JOIN INVTB ON TA001 = TB001 AND TA002 = TB002 
	INNER JOIN INVMB ON MB001 = TB004
	WHERE 1=1
	AND  TA001 = '1102'
-- 	AND TA006 = 'Y'
	AND TA002 IN ('20040358', '20040084', '20040329', '20040311', '20040312', '20050001', '20050002', '20050009', '20040361', '20050010', '20040360', '', '', '')
	GROUP BY TA006, TB004, MB002, TB014, TB012, TB013
) AS A ON ML001 = A.TB004 AND ML002 = A.TB012 AND ML004 = A.TB014
WHERE 1=1
-- AND SL > ML005
ORDER BY A.TB004