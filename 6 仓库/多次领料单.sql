/* 查询多次领料单
 * 注意：有多次领料单但对应领料数量为空，则多次领料单生成不全
 * 逻辑：以工单未领用量大于零为基础，延展出一次领料单；以一次领料单为基础，延展出二次领料单，以此类推
 *	 条件：工单已审，一次领料单已审；一次领料单不存在原单号（既为空）
 * 
 * 
 */

USE COMFORT

SELECT DISTINCT 
		RTRIM(TB001)+'-'+RTRIM(TB002) AS 工单单号, 
		(CASE WHEN TA011='1' THEN '未发料' WHEN TA011='2' THEN '已发料' WHEN TA011='3' THEN '生产中' WHEN TA011='Y' THEN '已完工' WHEN TA011='y' THEN '指定结束' END) AS 工单状态, 
		RTRIM(TB003) AS 品号, RTRIM(TB004) AS 应领量, 
		RTRIM(TB004-TB005) AS 未发量, 
		RTRIM(TE1.TE001) AS 一次领料别, RTRIM(TE1.TE002) AS 一次领料单号, TE1.TE005 AS 一次领料单数量, 
		RTRIM(TC2.TC001) AS 二次领料别, RTRIM(TC2.TC002) AS 二次领料单号, TC2.TC009 AS 二次领料审核情况, RTRIM(TE2.TE005) AS 二次领料数量, 
		RTRIM(TC3.TC001) AS 三次领料别, RTRIM(TC3.TC002) AS 三次领料单号, TC3.TC009 AS 三次领料审核情况, RTRIM(TE3.TE005) AS 三次领料数量, 
		RTRIM(TC4.TC001) AS 四次领料别, RTRIM(TC4.TC002) AS 四次领料单号, TC4.TC009 AS 四次领料审核情况, RTRIM(TE4.TE005) AS 四次领料数量, 
		RTRIM(TC5.TC001) AS 五次领料别, RTRIM(TC5.TC002) AS 五次领料单号, TC5.TC009 AS 五次领料审核情况, RTRIM(TE5.TE005) AS 五次领料数量
		FROM MOCTB
--工单单头信息
LEFT JOIN MOCTA ON TA001 = TB001 AND TB002 = TA002 
--一次领料单
LEFT JOIN MOCTE AS TE1 ON TE1.TE011 = TB001 AND TE1.TE012 = TB002 AND TE1.TE004 = TB003
LEFT JOIN MOCTC AS TC1 ON TC1.TC001 = TE1.TE001 AND TC1.TC002 = TE1.TE002 
--二次领料单
LEFT JOIN MOCTC AS TC2 ON TC2.TC019 = TC1.TC001 AND TC2.TC020 = TC1.TC002 AND TC2.TC009 <> 'V'
LEFT JOIN MOCTE AS TE2 ON TE2.TE001 = TC2.TC001 AND TE2.TE002 = TC2.TC002 AND TE2.TE004 = TB003 AND TE2.TE012 = TB002
--三次领料单
LEFT JOIN MOCTC AS TC3 ON TC3.TC019 = TC2.TC001 AND TC3.TC020 = TC2.TC002 AND TC3.TC009 <> 'V'
LEFT JOIN MOCTE AS TE3 ON TE3.TE001 = TC3.TC001 AND TE3.TE002 = TC3.TC002 AND TE3.TE004 = TB003 AND TE3.TE012 = TB002
--四次领料单
LEFT JOIN MOCTC AS TC4 ON TC4.TC019 = TC3.TC001 AND TC4.TC020 = TC3.TC002 AND TC4.TC009 <> 'V'
LEFT JOIN MOCTE AS TE4 ON TE4.TE001 = TC4.TC001 AND TE4.TE002 = TC4.TC002 AND TE4.TE004 = TB003 AND TE4.TE012 = TB002
--五次领料单
LEFT JOIN MOCTC AS TC5 ON TC5.TC019 = TC4.TC001 AND TC5.TC020 = TC4.TC002 AND TC5.TC009 <> 'V'
LEFT JOIN MOCTE AS TE5 ON TE5.TE001 = TC5.TC001 AND TE5.TE002 = TC5.TC002 AND TE5.TE004 = TB003 AND TE5.TE012 = TB002

WHERE 1=1 
AND TA011 != 'y'
AND TA013 = 'Y'
AND SUBSTRING(MOCTB.CREATE_DATE, 1, 6 ) = '201806'
AND TB004-TB005 > 0
AND TC1.TC009 = 'Y' 
AND RTRIM(TC1.TC020) = ''
AND TE1.TE001 LIKE '54%'
AND (TE2.TE002 IS NULL OR TE3.TE002 IS NULL OR TE4.TE002 IS NULL OR TE5.TE002 IS NULL)
ORDER BY RTRIM(TB001)+'-'+RTRIM(TB002), RTRIM(TE1.TE002), RTRIM(TB003)

