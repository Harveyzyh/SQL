
SELECT DISTINCT SUBSTRING(TW.CREATE_DATE,1,8) 领料单单身审核时间,
RTRIM(TA.TA001) AS 工单别, RTRIM(TA.TA002) AS 工单号, 
(CASE TA.TA011 WHEN '1' THEN '未生产' WHEN '2' THEN '已发料' WHEN '3' THEN '生产中' WHEN 'Y' THEN '已完工' END) AS 工单状态, 
RTRIM(TB.TB003) AS 品号, RTRIM(MB.MB002) AS 品名, TB.TB006 AS 工艺, TB.TB009 AS 工单仓位, TB.TB004 AS 工单需领用量, 
CONVERT(VARCHAR(20), (CONVERT(FLOAT, TB.TB004) - CONVERT(FLOAT, TB.TB005))) AS 工单未领用量, 
RTRIM(TC.TC019) 来源单别, RTRIM(TC.TC020) 来源单号, RTRIM(TC.TC001) AS 领退料单别, RTRIM(TC.TC002) AS 领退料单号, 
RTRIM(TC.TC009) AS 领退料单头审核码, RTRIM(TE.TE019) AS 领退料单身审核码, 
TE.TE003 AS 领退料单序号, (CASE SUBSTRING(TC.TC001,1,2) WHEN '54' THEN '领料' WHEN '56' THEN '退料' ELSE TC.TC001 END) 领退料, 
TE.TE005 AS 领退料数量, TE.TE027 AS 领退料库存数量, TE.TE008 AS 领料单仓位, TE.TE010 AS 领料单批号

FROM MOCTA AS TA
INNER JOIN MOCTB AS TB ON TA.TA001 = TB.TB001 AND TA.TA002 = TB.TB002
LEFT JOIN MOCTE AS TE ON TB.TB001 = TE.TE011 AND TB.TB002 = TE.TE012 AND TB.TB003 = TE.TE004 AND TE.TE009 = TB.TB006
INNER JOIN MOCTC AS TC ON TE.TE001 = TC.TC001 AND TE.TE002 = TC.TC002 
LEFT JOIN INVLA AS LA ON LA.LA006 = TC.TC001 AND LA.LA007 = TC.TC002 AND LA.LA001 = TE.TE004 AND RTRIM(TA.TA001) + '-' + RTRIM(TA.TA002) = RTRIM(LA.LA024) AND LA.LA008 = TE.TE003
INNER JOIN INVMB AS MB ON TB.TB003 = MB.MB001

INNER JOIN MOCTENoTwice AS TW ON TW.TE011 = TB.TB001 AND TW.TE012 = TB.TB002 AND TW.TE004 = TB.TB003 AND TW.TE009 = TB.TB006

INNER JOIN (
	SELECT RTRIM(TB001) TB01, RTRIM(TB002) TB02, RTRIM(TB003) TB03, RTRIM(TB006) TB06, COUNTTE2 FROM MOCTB
	LEFT JOIN (
		SELECT TE011, TE012, COUNT(TE002) COUNTTE2 FROM MOCTE 
		WHERE TE019 = 'N'
		GROUP BY TE011, TE012
		) AS TE1 ON TE011 = TB001 AND TE012 = TB002
	WHERE 1=1
	--AND SUBSTRING(TB002, 1, 4) = '1812'
	AND COUNTTE2 IS NULL
) AS TE2 ON TE2.TB01 = RTRIM(TB.TB001) AND TE2.TB02 = RTRIM(TB.TB002) AND TE2.TB03 = RTRIM(TB.TB003) AND TE2.TB06 = RTRIM(TB.TB006)

WHERE 1=1
AND TA.TA013 != 'V' AND TA.TA011 != 'y' --AND TC009 != 'V'
--AND TC.TC009 = 'Y'
--AND TE.TE019 = 'N'
AND TA.TA011 IN ('2', '3')
AND SUBSTRING(TW.CREATE_DATE, 1, 8) = '20190115'
AND (CONVERT(FLOAT, TB.TB004) - CONVERT(FLOAT, TB.TB005)) > 0
ORDER BY RTRIM(TA.TA001), RTRIM(TA.TA002), RTRIM(TB.TB003), TB.TB006, RTRIM(TC.TC001), RTRIM(TC.TC002), TE.TE003



--|领料单未生成二次单据的
SELECT TW.*, TA.TA011, TC.TC001, TC.TC002, TC.TC009, TE.TE003, TE.TE004, TE.TE009 FROM MOCTENoTwice AS TW
LEFT JOIN MOCTC AS TC ON TW.TE001=TC.TC019 AND TW.TE002=TC.TC020
LEFT JOIN MOCTE AS TE ON TC.TC001 = TE.TE001 AND TC.TC002 = TE.TE002 AND TW.TE004 = TE.TE004 AND TW.TE009 = TE.TE009 AND TW.TE012 = TE.TE012
LEFT JOIN MOCTB AS TB ON TW.TE011=TB.TB001 AND TW.TE012=TB.TB002 AND TW.TE004=TB.TB003 AND TW.TE009=TB.TB006
LEFT JOIN MOCTA AS TA ON TW.TE011 = TA.TA001 AND TW.TE012 = TA.TA002
WHERE TW.TE005 != WLL
--AND TC002 IS NULL
AND TE.TE004 IS NULL
AND TB004-TB005>0
AND TW.OK = 'N'
--AND TA.TA011 != 'y'
--AND TW.TE002 = '19011532'
ORDER BY TW.CREATE_DATE

--修改标志位，使其下次不出现
SELECT * FROM MOCTENoTwice
--UPDATE MOCTENoTwice SET OK = 'Y' 
WHERE TE002 = '19011532' AND TE004 = '402050001' AND TE012 = '18085030'