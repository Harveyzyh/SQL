
-- 请购单头单身审核码不一致的
SELECT TA001, TA002, TB004, TA007, TB025  
-- UPDATE PURTB SET TB025 = TA007
FROM PURTA(NOLOCK) 
INNER JOIN PURTB(NOLOCK) ON TA001 = TB001 AND TA002 = TB002
WHERE 1=1
AND TA003 >= '20200101'
AND TA007 <> TB025
ORDER BY TA001, TA002 


-- 查找出存在PURTR对比PURTB缺漏的单别单号
SELECT DISTINCT RTRIM(TA001)+'-'+RTRIM(TA002) 请购单号, TA007, TB025  
FROM PURTA(NOLOCK) 
INNER JOIN PURTB(NOLOCK)  ON TA001 = TB001 AND TA002 = TB002
LEFT JOIN PURTR(NOLOCK)  ON TR001 = TB001 AND TR002 = TB002 AND TR003 = TB003
WHERE 1=1
-- AND TA007 <> TB025
AND TA003 >= '20200101'
AND TA007 = 'Y'
AND TR004 IS NULL 
ORDER BY RTRIM(TA001)+'-'+RTRIM(TA002)


-- 根据单别单号，补全PURTR对比PURTB缺漏项
-- INSERT INTO PURTR (COMPANY, CREATOR, CREATE_DATE, FLAG, TR001, TR002, TR003, TR004, TR005, TR006, TR007, TR008, TR009, TR010, TR011, TR012, TR013, TR014, TR015, TR016, TR017, TR018, TR019, TR020, TR021, TR022, TR023, TR024, TR025, TR026, TR027)

SELECT K.COMPANY, K.CREATOR, K.CREATE_DATE, K.FLAG, TB001 AS TR001, TB002 AS TR002, TB003 AS TR003, '0001' AS TR004, 
TB010 AS TR005, TB009 AS TR006, 1 AS TR007, TB007 AS TR008, MA021 AS TR009, TB017 AS TR010, TB018 AS TR011, TB026 AS TR012, 
TB019 AS TR013, TB008 AS TR014, TB032 AS TR015, TB024 AS TR016, 'N' AS TR017, 'N' AS TR018, '' AS TR019, TB035 AS TR020, 
TB038 AS TR021, TB040 AS TR022, TB041 AS TR023, TB028 AS TR024, TB042 AS TR025, TB043 AS TR026, TB044 AS TR027
FROM PURTB(NOLOCK)  
INNER JOIN PURTA(NOLOCK)  ON TA001 = TB001 AND TA002 = TB002 
LEFT JOIN PURTR(NOLOCK)  ON TB001 = TR001 AND TB002 = TR002 AND TB003 = TR003 
LEFT JOIN PURMA(NOLOCK)  ON MA001 = TB010
LEFT JOIN (SELECT TOP 1 COMPANY, CREATOR, CREATE_DATE, FLAG FROM PURTR(NOLOCK)  WHERE RTRIM(TR001)+'-'+RTRIM(TR002) = '3101-19090149') AS K ON 1=1
WHERE 1=1
AND RTRIM(TB001)+'-'+RTRIM(TB002) = '3101-19090149' 
-- AND TA007 = 'Y' 
-- AND TB025 != 'Y'
AND TR003 IS NULL


-- PURTB里未结束，但是PURTR里已经结束了的
SELECT TA003, TB001, TB002, TB003, TB004, TB020, TB021, TB039, TR017, TR018 
-- UPDATE PURTR SET TR017 = TB039 
FROM PURTA 
INNER JOIN PURTB ON TA001 = TB001 AND TA002 = TB002  
INNER JOIN PURTR ON TB001 = TR001 AND TB002 = TR002 AND TB003 = TR003 
WHERE 1=1 AND TA003 >= '20200101'
AND TA007 = 'Y'
AND TB039 = 'N' 
AND TR017 = 'Y'





