SELECT SC_PLAN.K_ID, SC001, SC003, SC013, SC023, TA001, TA002, TA015, TA064, MOCTA.UDF02 
-- UPDATE MOCTA SET MOCTA.UDF02 = SC_PLAN.K_ID
FROM WG_DB..SC_PLAN 
LEFT JOIN MOCTA ON RTRIM(TA026)+'-'+RTRIM(TA027)+'-'+RTRIM(TA028) = SC001 AND TA015 = SC013 AND TA006 = SC028 AND TA013 NOT IN ('V', 'U') AND TA011 NOT IN ('y') 
WHERE 1=1
AND NOT EXISTS(SELECT 1 FROM WG_DB..SC_PLAN AS SC2 WHERE SC_PLAN.SC001 = SC2.SC001 GROUP BY SC2.SC001, SC2.SC003, SC2.SC013, SC2.SC023 HAVING COUNT(*) > 1)
AND NOT EXISTS(SELECT 1 FROM MOCTA AS TA2 WHERE RTRIM(TA2.TA026)+'-'+RTRIM(TA2.TA027)+'-'+RTRIM(TA2.TA028) = SC001 GROUP BY RTRIM(TA2.TA026)+'-'+RTRIM(TA2.TA027)+'-'+RTRIM(TA2.TA028), TA015 HAVING COUNT(*) > 1)
AND TA001 = '5101'
AND (MOCTA.UDF02 IS NULL OR MOCTA.UDF02 != SC_PLAN.K_ID)
AND SC003 >= '20200901'

ORDER BY SC003, SC001, SC_PLAN.K_ID


