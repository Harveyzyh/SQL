
-- 年月汇总
SELECT RTRIM(MB001) 品号, RTRIM(MB002) 品名, RTRIM(MB003) 规格, JH.JYDATE 交易年月, JSL 进货数量, (CASE WHEN TSL IS NULL THEN 0 ELSE TSL END) 退货数量, 
MB004 单位, (CASE MB109 WHEN 'Y' THEN '已核准' WHEN 'N' THEN '尚待核准' WHEN 'y' THEN '不许交易' END) 核准状况 
FROM INVMB
FULL JOIN (
SELECT SUBSTRING(LA004, 1, 4) + '-' + SUBSTRING(LA004, 5, 2) JYDATE, LA001, SUM(LA011) JSL FROM INVLA 
WHERE LA006 LIKE '3%' 
AND LA016 = 'A0106'
AND LA005 = '1'
GROUP BY SUBSTRING(LA004, 1, 4) + '-' + SUBSTRING(LA004, 5, 2), LA001
) AS JH ON MB001 = JH.LA001
FULL JOIN (
SELECT SUBSTRING(LA004, 1, 4) + '-' + SUBSTRING(LA004, 5, 2) JYDATE, LA001, SUM(LA011) TSL FROM INVLA 
WHERE LA006 LIKE '3%' 
AND LA016 = 'A0106'
AND LA005 = '-1'
GROUP BY SUBSTRING(LA004, 1, 4) + '-' + SUBSTRING(LA004, 5, 2), LA001
) AS TH ON MB001 = TH.LA001 AND JH.JYDATE = TH.JYDATE
WHERE (JH.LA001 IS NOT NULL OR TH.LA001 IS NOT NULL)
AND JH.JYDATE >= '2017-01'
ORDER BY JH.LA001, JH.JYDATE


-- 年份汇总
SELECT RTRIM(MB001) 品号, RTRIM(MB002) 品名, RTRIM(MB003) 规格, JH.JYDATE 交易年月, JSL 进货数量, (CASE WHEN TSL IS NULL THEN 0 ELSE TSL END) 退货数量, 
MB004 单位, (CASE MB109 WHEN 'Y' THEN '已核准' WHEN 'N' THEN '尚待核准' WHEN 'y' THEN '不许交易' END) 核准状况 
FROM INVMB
FULL JOIN (
SELECT SUBSTRING(LA004, 1, 4) JYDATE, LA001, SUM(LA011) JSL FROM INVLA 
WHERE LA006 LIKE '3%' 
AND LA016 = 'A0106'
AND LA005 = '1'
GROUP BY SUBSTRING(LA004, 1, 4), LA001
) AS JH ON MB001 = JH.LA001
FULL JOIN (
SELECT SUBSTRING(LA004, 1, 4) JYDATE, LA001, SUM(LA011) TSL FROM INVLA 
WHERE LA006 LIKE '3%' 
AND LA016 = 'A0106'
AND LA005 = '-1'
GROUP BY SUBSTRING(LA004, 1, 4), LA001
) AS TH ON MB001 = TH.LA001 AND JH.JYDATE = TH.JYDATE
WHERE (JH.LA001 IS NOT NULL OR TH.LA001 IS NOT NULL)
AND JH.JYDATE >= '2017'
ORDER BY JH.LA001, JH.JYDATE