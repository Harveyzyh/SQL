SELECT TL004, TM004, CAST(TM010 AS FLOAT) AS TM010, TM014 FROM PURTL
INNER JOIN PURTM ON TL001 = TM001 AND TL002 = TM002
INNER JOIN
(
	SELECT TM004 AS ATM004, TL004 AS ATL004, MAX(TM014) AS ATM014 
	FROM PURTL
	INNER JOIN PURTM ON TL001 = TM001 AND TL002 = TM002 
	WHERE 1=1
	AND TL006 = 'Y'
	AND TM011 = 'Y'
	AND (RTRIM(TM015) = '' OR TM015 IS NULL OR TM015 > CONVERT(VARCHAR(8), GETDATE(), 112))
	AND TM014 <= CONVERT(VARCHAR(8), GETDATE(), 112)
	GROUP BY TM004, TL004 
)  AS A ON  ATM004 = TM004 AND ATL004 = TL004 AND TM014 = ATM014
WHERE 1=1
AND TL006 = 'Y'
AND TM011 = 'Y'
AND TM004 = '401010035' AND TL004 = 'A0002'
ORDER BY TM014 DESC, TL003 DESC 



SELECT TM004, TM010, TL004, TM014 FROM V_GetPrice 
where 1=1
AND TM004 = '401010035' AND TL004 = 'A0002'
