-- 想在二次领料单生成之后，自动把以为BMSAB01导致丢失的项补回去的
-- 但是感觉不太行，总感觉有点问题
-- 可能忽略已审核的单会好一些
SELECT TC1.TC001, TC1.TC002, LLXA012 AS TE004, TB004-TB005-ISNULL(TE1.TE005, 0) AS TE005, LLXA013 AS TE008, LLXA011 AS TE009, 
LLXA015 AS TE010, LLXA009 AS TE011, LLXA010 AS TE012, TC1.TC019, TC1.TC020, LL_LYXA.CREATE_DATE, LLXA007
FROM dbo.MOCTC AS TC1 
INNER JOIN dbo.LL_LYXA ON TC1.TC019 = LLXA001 AND TC1.TC020 = LLXA002 AND LLXA019 = 'Y' 
INNER JOIN dbo.MOCTA ON TA001 = LLXA009 AND TA002 = LLXA010 AND TA011 IN ('2', '3')
INNER JOIN dbo.MOCTB ON TA001 = TB001 AND TA002 = TB002 AND TB006 = LLXA011 AND TB003 = LLXA012 
LEFT JOIN (
	SELECT TE011, TE012, TE004, TE009, SUM(TE005) AS TE005 FROM dbo.MOCTE(NOLOCK)
	INNER JOIN dbo.MOCTC ON TC001 = TE001 AND TC002 = TE002 AND TC009 = 'N'
	GROUP BY TE011, TE012, TE004, TE009 
) AS TE1 ON TE1.TE011 = TB001 AND TE1.TE012 = TB002 AND TE1.TE004 = TB003 AND TE1.TE009 = TB006 -- 未审核领料量

-- LEFT JOIN dbo.MOCTE AS TE2 ON TC1.TC001 = TE2.TE001 AND TC1.TC002 = TE2.TE002 AND TE2.TE004 = LLXA012 AND TE2.TE011 = LLXA009 AND TE2.TE012 = LLXA010 AND TE2.TE009 = LLXA011 

WHERE 1=1
AND LEFT(TC1.TC019, 2) = '54'
AND TC1.TC019 IS NOT NULL AND RTRIM(TC1.TC019) != '' 
AND TB004-TB005-ISNULL(TE1.TE005, 0) > 0 -- 排除已经额外补单的情况 
AND NOT EXISTS (SELECT * FROM dbo.MOCTB AS TB2 WHERE TB2.TB001 = TA001 AND TB2.TB002 = TA001 GROUP BY TB2.TB001, TB2.TB002 HAVING SUM(TB2.TB005) > 0) -- 排除整单退料
AND TC1.TC009 = 'N' 
-- AND TE2.TE003 IS NULL
AND LLXA017 != TB004
AND LEFT(LL_LYXA.CREATE_DATE, 8) >= '20200601'
-- AND TA002 = '19114190'
ORDER BY LLXA007, LLXA009, LLXA010, LLXA012, TC1.TC001, TC1.TC002 
