SELECT DISTINCT LLXA009, LLXA010 
FROM LL_LYXA(NOLOCK) 
INNER JOIN MOCTB(NOLOCK) ON TB001 = LLXA009 AND TB002 = LLXA010 AND TB003 = LLXA012 AND TB006 = LLXA011
INNER JOIN MOCTA(NOLOCK) ON TA001 = TB001 AND TA002 = TB002 
LEFT JOIN (
	SELECT TE011, TE012, TE004, TE009, SUM(TE005) AS TE005 FROM MOCTC INNER JOIN MOCTE ON TC001 = TE001 AND TC002 = TE002 AND TC009 = 'N'
	GROUP BY TE011, TE012, TE004, TE009 
) AS TE2 ON TE2.TE011 = TB001 AND TE2.TE012 = TB002 AND TB003 = TE2.TE004 AND TE2.TE009 = TB006
LEFT JOIN MOCTE AS TE1 ON TE1.TE001 = LLXA001 AND TE1.TE002 = LLXA002 AND TE1.TE004 = LLXA012 AND TE1.TE009 = LLXA011 AND TE1.TE011 = LLXA009 AND TE1.TE012 = LLXA010
WHERE LLXA019 = 'Y' 
AND TA011 NOT IN ('Y', '1', 'y')
AND TB004-TB005-ISNULL(TE2.TE005, 0) > 0
AND TE1.TE004 IS NULL
AND LLXA010 >= '20010001'
ORDER BY LLXA009, LLXA010

