SELECT DISTINCT ME002 部门, MOCTA.UDF04 贸易方式, TA027 订单号, TA001 工单别, TA002 工单号, 
ISNULL(TEU009, '') 破核, 
ISNULL(TBB000, '') 变更 
FROM MOCTA(NOLOCK) 
INNER JOIN MOCTB(NOLOCK) AS TB ON TA001 = TB001 AND TA002 = TB002 
LEFT JOIN ( 
	SELECT TE011, TE012, TE004, TE009, SUM(TE005) AS TE005 FROM MOCTE(NOLOCK)  
	INNER JOIN MOCTC(NOLOCK) ON TC001 = TE001 AND TC002 = TE002 
	WHERE 1=1 
	AND TC009 = 'N' 
	GROUP BY TE011, TE012, TE004, TE009 
) AS MOCTE ON TE011 = TB001 AND TE012 = TB002 AND TB003 = TE004 AND TB006 = TE009	 
LEFT JOIN (  
	SELECT TE011 AS TEU011, TE012 AS TEU012, '破核' AS TEU009 FROM MOCTE(NOLOCK) INNER JOIN MOCTC(NOLOCK) ON TC001 = TE001 AND TC002 = TE002 WHERE TC009 = 'U' 
) AS TEU ON TEU011 = TB001 AND TEU012 = TB002 
LEFT JOIN ( 
	SELECT DISTINCT TB001 AS TBB001, TB002 AS TBB002, '变更' AS TBB000 FROM MOCTB(NOLOCK) WHERE RTRIM(TB037) = ''  
) AS TBB ON TBB001 = TB001 AND TBB002 = TB002 
LEFT JOIN CMSME ON ME001 = TA064
WHERE 1=1 
AND EXISTS(SELECT 1 FROM MOCTB AS TB2 WHERE TB2.TB005>0 AND TB2.TB001=TB.TB001 AND TB2.TB002=TB.TB002 AND TB2.TB006=TB.TB006)  
AND TA013 = 'Y'  
AND TA011 IN ('1' ,'2')  
AND TB004-TB005>0  
AND TE005 IS NULL  
AND TA003 >= '20200401'  
AND TB011 != '4'  

ORDER BY ME002, MOCTA.UDF04, TA027, TA001, TA002  