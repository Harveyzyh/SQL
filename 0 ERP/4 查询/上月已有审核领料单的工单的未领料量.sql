SELECT TB001, RTRIM(TB002) TB002, TB006, RTRIM(TB003) MB001, RTRIM(MB002) MB002, RTRIM(MB003) MB003, CAST(TB004 AS FLOAT) TB004, CAST((TB004-TB005) AS FLOAT) DL
FROM COMFORT.dbo.MOCTB 
INNER JOIN COMFORT.dbo.INVMB ON MB001 = TB003
INNER JOIN( 
	SELECT DISTINCT TB001 AS ATB001, TB002 AS ATB002, TB003 AS ATB003, TB006 AS ATB006 
	FROM COMFORT.dbo.MOCTA 
	INNER JOIN COMFORT.dbo.MOCTB ON TA001 = TB001 AND TA002 = TB002 
	WHERE 1=1 
	AND TA011 NOT IN ('y', 'Y', '1') 
	AND EXISTS ( 
		SELECT 1 FROM COMFORT.dbo.MOCTE INNER JOIN COMFORT.dbo.MOCTC ON TC001 = TE001 AND TC002 = TE002 
		WHERE 1=1 
		AND TE011 = TB001 AND TE012 = TB002 
		AND TC009 = 'Y' 
-- 		AND SUBSTRING(TC003, 1, 6) = '202003'
		AND SUBSTRING(TC003, 1, 6) = CONVERT(VARCHAR(6), DATEADD(MONTH, -1, GETDATE()), 112) -- 上月
	)
	AND EXISTS (
		SELECT 1 FROM COMFORT.dbo.MOCTB AS MOCTB2 
		WHERE 1=1
		AND MOCTB2.TB001 = MOCTB.TB001 AND MOCTB2.TB002 = MOCTB.TB002
		AND MOCTB2.TB004 - MOCTB2.TB005 >0
	)
	AND NOT EXISTS (
		SELECT 1 FROM COMFORT.dbo.MOCTB AS MOCTB3 
		WHERE 1=1
		AND MOCTB3.TB001 = MOCTB.TB001 AND MOCTB3.TB002 = MOCTB.TB002
		GROUP BY MOCTB3.TB001, MOCTB3.TB002 HAVING SUM(MOCTB3.TB005) = 0 
	)
) AS A ON ATB001 = TB001 AND ATB002 = TB002 AND ATB003 = TB003 AND ATB006 = TB006
WHERE 1=1
-- AND TB002 = '20011200'
AND TB004-TB005 > 0 -- 未领料量大于0
ORDER BY TB001, TB002, TB006, MB001
