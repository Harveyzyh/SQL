-- 

SELECT RTRIM(ME002) 部门, RTRIM(TB001) 工单单别, RTRIM(TB002) 工单单号, RTRIM(TB003) 材料品号, RTRIM(MB002) 品名, RTRIM(MB003) 规格, 
TB004 需领用数量, TB005 未领用数量, RTRIM(TB006) 工艺, RTRIM(MB004) 单位, RTRIM(TB009) 发料仓库 
FROM MOCTA 
INNER JOIN MOCTB ON TA001 = TB001 AND TA002 = TB002 
INNER JOIN INVMB ON MB001 = TB003
INNER JOIN CMSME ON TA064 = ME001
WHERE 1=1
AND EXISTS 
( 
	SELECT 1 FROM 
	(
	SELECT DISTINCT TD003, TD004, GY FROM 
	(
		SELECT TD001, TD002, TD003, TD004, TD009 AS GY FROM MOCTD
		UNION 
		SELECT TD001, TD002, TD003, TD004, TD010 AS GY FROM MOCTD
		UNION 
		SELECT TD001, TD002, TD003, TD004, TD011 AS GY FROM MOCTD
		UNION 
		SELECT TD001, TD002, TD003, TD004, TD012 AS GY FROM MOCTD
		) AS MOCTDC WHERE GY IS NOT NULL AND RTRIM(GY) != ''
	) AS MOCTD 
	WHERE TD003 = TB001 AND TD004 = TB002 AND GY = TB006
)
AND NOT EXISTS
(
	SELECT 1 FROM MOCTE WHERE TE011 = TB001 AND TE012 = TB002 AND TB003 = TE004 AND TB006 = TE009
)
AND TB004 != 0 -- 需领用量：不为0
AND TB011 != 4 -- 材料类型：不为不发料
AND TA011 NOT IN ('Y', 'y') -- 工单状态：不为已完工、指定结束
AND TB001 = '5101' 
-- AND TB002 = '19110076'
ORDER BY ME002, TB001, TB002, TB003
