
SELECT DISTINCT RTRIM(AA.TR001) ATR001,RTRIM(AA.TR002) ATR002, AA.TQ004--,AA.TR003 ATR003,AA.TR009 ATR009
FROM 
(SELECT TR001,TR002,TR003,TR004,TR009, TQ004
 FROM COPTQ
 INNER JOIN COPTR ON TR001=TQ001 AND TR002=TQ002 
 INNER JOIN BOMMC ON MC001=TR009
 WHERE TQ006<>'V' AND MC017='1' 
 AND TR017 = 'Y'
) AS AA
LEFT JOIN 
(SELECT TR001,TR002,SUBSTRING(TR003,1,LEN(TR003)-3) TR003A,TR004,ISNULL(COUNT(*),0) AS BS
 FROM COPTQ
 INNER JOIN COPTR ON TR001=TQ001 AND TR002=TQ002  
 WHERE TR017='Y' AND TQ006<>'V'
 GROUP BY TR001,TR002,SUBSTRING(TR003,1,LEN(TR003)-3),TR004
) AS BB ON AA.TR001=BB.TR001 AND AA.TR002=BB.TR002 AND AA.TR009=BB.TR004 AND BB.TR003A=AA.TR003
where 
BB.TR001 IS NULL
--AND AA.TQ004 >= '20170101'
ORDER BY RTRIM(AA.TR001),RTRIM(AA.TR002)--,BB.TR004