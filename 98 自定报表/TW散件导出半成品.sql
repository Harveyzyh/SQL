SELECT RTRIM(TH001) + '-' + RTRIM(TH002) + '-' + RTRIM(TH003) DD, MB1.MB001 CPNO, MB1.MB002 CPNAME, MB1.MB003 CPSPEC, 
MB2.MB001 WLNO, MB2.MB002 WLNAME, MB2.MB003 WLSPEC, SUM(CONVERT(NUMERIC(16, 4), CB008/CB009*TH008)) SL
FROM BOMCB
INNER JOIN INVMB AS MB1 ON MB1.MB001 = CB001
INNER JOIN INVMB AS MB2 ON MB2.MB001 = CB005
INNER JOIN COPTH AS TH ON TH.TH005 = CB001
WHERE 1=1
AND MB1.MB109 = 'Y'
AND MB1.MB003 LIKE '%TW散件%'
GROUP BY RTRIM(TH001) + '-' + RTRIM(TH002) + '-' + RTRIM(TH003), MB1.MB001, MB1.MB002, MB1.MB003, MB2.MB001, MB2.MB002, MB2.MB003