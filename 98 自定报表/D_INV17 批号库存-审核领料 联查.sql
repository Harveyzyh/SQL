SELECT INVMB.MB001 as INVMBMB001,INVMB.MB002 as INVMBMB002,INVMB.MB003 as INVMBMB003,INVMB.MB004 as INVMBMB004,
INVML.ML002 as INVMLML002,INVML.ML004 as INVMLML004,INVML.ML005 as INVMLML005,CMSMC.MC002 as CMSMCMC002,ISNULL(KK.WL, 0) AS KKWL 
FROM $$INVME AS INVME 
INNER JOIN $$INVML AS INVML ON INVME.ME001 = INVML.ML001 AND INVME.ME002 = INVML.ML004 
INNER JOIN $$INVMB AS INVMB ON INVMB.MB001 = INVME.ME001 
INNER JOIN $$CMSMC AS CMSMC ON CMSMC.MC001 = INVML.ML002 
LEFT JOIN 
(
SELECT TE004, TE010, SUM(TE005) AS WL FROM $$MOCTC AS MOCTC 
INNER JOIN $$MOCTE AS MOCTE ON MOCTC.TC001 = MOCTE.TE001 AND MOCTC.TC002 = MOCTE.TE002 
WHERE 1=1 
AND MOCTC.TC009 = 'N' 
GROUP BY TE004, TE010 
) AS KK ON KK.TE004 = INVME.ME001 AND KK.TE010 = INVML.ML004 
WHERE &&OpenOption 
AND INVML.ML005 != 0 
ORDER BY INVML.ML001 ASC ,INVML.ML002 ASC, INVML.ML004 ASC 
