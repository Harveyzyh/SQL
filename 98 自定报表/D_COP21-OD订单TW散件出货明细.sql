
-- 订单信息，品名，销货数量，预计装箱数量，实际订单数量，实际装箱数量，配置方案描述



SELECT DD AS DD订单信息, WLNO AS WLNO品号, WLNAME AS WLNAME品名, 
CONVERT(FLOAT, SUM(XHSL)) AS XHSL销货数量, CONVERT(FLOAT, SUM(YJZGSL)) AS YJZGSL预计装柜数量, '' AS SJXHSL实际订单数量, '' AS SJZGSL实际装柜数量, 
SPEC AS 'SPEC配置方案描述/规格'
FROM COPTG
INNER JOIN
( 
	-- 按销货单取出组立明细，并按对应BOM中规格含A=A的品名含纸箱的用量计算出货量
	SELECT TG001 AS TG001D, TG002 AS TG002D, RTRIM(TD001) + '-' + RTRIM(TD002) + '-' + RTRIM(TD003) AS DD, RTRIM(TH004) AS WLNO, RTRIM(TH005) AS WLNAME, 
	TH008 AS XHSL, LS1.DS * TH008 AS YJZGSL, RTRIM(TD053) AS SPEC, '' AS XH
	FROM COPTG INNER JOIN COPTH ON TH001 = TG001 AND TH002 = TG002 LEFT JOIN COPTD ON TH014 = TD001 AND TH015 = TD002 AND TH016 = TD003 
	INNER JOIN 
	( 
		SELECT TG001 AS TG001C, TG002 AS TG002C, CB001, CAST(CB008/CB009 AS NUMERIC(10, 4)) AS DS FROM BOMCB 
		INNER JOIN INVMB ON MB001 = CB005 
		INNER JOIN COPTG ON 1=1 
		WHERE 1=1 AND MB002 LIKE '%纸箱%' AND MB003 LIKE '%A=A%' 
		AND (RTRIM(CB013) = '' OR CB013 IS NULL OR RTRIM(TG042) >= RTRIM(CB013)) 
		AND (RTRIM(CB014) = '' OR CB014 IS NULL OR RTRIM(TG042) <= RTRIM(CB014)) 
	) AS LS1 ON CB001 = TH004 AND TG001 = TG001C AND TG002 = TG002C 
	WHERE 1=1 AND TH005 LIKE '%组立%' 
	
	UNION 
	
	-- 按BOM取出包材明细，并按BOM用量计算出货量
	SELECT TG001, TG002, RTRIM(TD001) + '-' + RTRIM(TD002) + '-' + RTRIM(TD003) AS DD, RTRIM(CB005) AS WLNO, RTRIM(MB002) AS WLNAME, 
	TH008 AS XHSL, LS1.DS * TH008 AS YJZGSL, RTRIM(MB003) AS SPEC, CB004 AS XH 
	FROM COPTG INNER JOIN COPTH ON TH001 = TG001 AND TH002 = TG002 LEFT JOIN COPTD ON TH014 = TD001 AND TH015 = TD002 AND TH016 = TD003 
	INNER JOIN 
	( 
		SELECT TG001 AS TG001C, TG002 AS TG002C, CB001, CB004, CB005, MB002, MB003, CAST(CB008/CB009 AS NUMERIC(10, 4)) AS DS FROM BOMCB 
		INNER JOIN INVMB ON MB001 = CB005 
		INNER JOIN COPTG ON 1=1 
		WHERE 1=1 AND RTRIM(CB011) = '0801'
		AND (RTRIM(CB013) = '' OR CB013 IS NULL OR RTRIM(TG042) >= RTRIM(CB013)) 
		AND (RTRIM(CB014) = '' OR CB014 IS NULL OR RTRIM(TG042) <= RTRIM(CB014)) 
	) AS LS1 ON CB001 = TH004 AND TG001 = TG001C AND TG002 = TG002C 
	WHERE 1=1 AND TH005 LIKE '%包材%' 
	
	UNION 
	
	-- 除去包材和组立，获取明细，按销货单数量作为出货量
	SELECT TG001, TG002, RTRIM(TD001) + '-' + RTRIM(TD002) + '-' + RTRIM(TD003) AS DD, RTRIM(TH004) AS WLNO, RTRIM(TH005) AS WLNAME, 
	TH008 AS XHSL, TH008 AS YJZHSL, RTRIM(TD053) AS SPEC, '' AS XH 
	FROM COPTG INNER JOIN COPTH ON TH001 = TG001 AND TH002 = TG002 LEFT JOIN COPTD ON TH014 = TD001 AND TH015 = TD002 AND TH016 = TD003 
	WHERE 1=1 AND (TH005 NOT LIKE '%包材%' AND TH005 NOT LIKE '%组立%') 
	
) AS DDXX ON TG001D = TG001 AND TG002D = TG002
WHERE 1=1 
AND TG001 = '2301' AND TG002 = '19100013' 
GROUP BY DD, WLNO, WLNAME, SPEC, XH
ORDER BY DD, XH 
















