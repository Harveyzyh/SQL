SELECT DISTINCT A.MB001, A.MB002, A.MB003, B.MB032, B.MA002, C.MBUNF06, C.MA002, D.MG001 
FROM

(SELECT MB001, MB002, MB003 FROM INVMB
LEFT JOIN CMSMC ON MC001 = MB017 
WHERE MB109 <> 'N'
--MB002 NOT LIKE '%停用%' 
AND MB017 = 'P013' 
AND ( MB001 LIKE '3%' OR MB001 LIKE '4%' ) 
--AND MB001 LIKE '3%'
AND (MB003 LIKE '%91701%' OR MB003 LIKE '%81701%')
AND SUBSTRING(INVMB.CREATE_DATE, 1, 6) >= '201804'
 ) AS A,

(SELECT MB001, MB032, MA002 FROM INVMB
LEFT JOIN PURMA ON MA001 = MB032 ) AS B,

(SELECT MB001, INVMB.UDF06 MBUNF06, MA002 FROM INVMB
LEFT JOIN PURMA ON MA001 = INVMB.UDF06 ) AS C,

(SELECT MB001, MG001 FROM INVMB
LEFT JOIN BMSMG ON MG002 = MB001 AND MG003 = MB002 AND MG004 = MB003 ) AS D

WHERE A.MB001 = B.MB001
AND A.MB001 = C.MB001
AND A.MB001 = D.MB001
AND D.MG001 IS NULL
AND (B.MB032 <> '' AND C.MBUNF06 <> '')
AND B.MB032 <> '999' 
AND C.MBUNF06 <> '999'
ORDER BY A.MB001
