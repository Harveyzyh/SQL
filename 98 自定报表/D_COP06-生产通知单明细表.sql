SELECT 
(CASE WHEN TC004='0118' THEN '内销' ELSE '外销' END) X002,
(RTRIM(COPTD.TD001)+'-'+RTRIM(COPTD.TD002)+'-'+RTRIM(COPTD.TD003)+(CASE WHEN X.UDF51='1' THEN '(新增)' WHEN X.UDF51='0' THEN '(变更)' ELSE '' END)) as X001,
RTRIM(COPMA.MA002) as COPMAMA002,
RTRIM(COPTC.TC015) as COPTCTC015,
(CASE WHEN X.TF003 IS NULL THEN '' WHEN X.TF003 IS NOT NULL AND X.TF017 = 'Y' THEN '指定结束'+':'+'变更版本号'+X.TF003+'_'+X.UDF11 ELSE '变更版本号'+X.TF003+'_'+X.UDF11 END) as X006, 
SUBSTRING(RTRIM(COPTD.TD013),1,4)+'-'+SUBSTRING(RTRIM(COPTD.TD013),5,2)+'-'+SUBSTRING(RTRIM(COPTD.TD013),7,2) AS COPTDTD013, 
RTRIM(COPTD.UDF03) as COPTDUDF03, 
RTRIM(COPTD.UDF01) as COPTDUDF01, 
RTRIM(COPTD.TD005) as COPTDTD005, 
RTRIM(COPTD.UDF08) as COPTDUDF08, 
RTRIM(COPTD.TD006) as COPTDTD006, 
CONVERT(INT, COPTD.TD008) as COPTDTD008, 
CONVERT(INT, COPTD.TD024) as COPTDTD024, 
RTRIM(COPTD.TD053) as COPTDTD053, 
RTRIM(COPTQ.TQ003) as COPTQTQ003, 
RTRIM(COPTD.TD020) as X008, 
RTRIM(COPTD.TD204) as COPTDTD204, 
RTRIM(COPTC.TC035) as COPTCTC035, 
RTRIM(CMSMV.MV002) as CMSMVMV002, 
RTRIM(COPTC.TC012) as COPTCTC012, 
RTRIM(COPTD.TD014) as COPTDTD014, 
(CASE WHEN TC004='0118' THEN INVMB.UDF04 ELSE INVMB.UDF05 END) X003, 
RTRIM(COPTD.UDF05) as COPTDUDF05, 
RTRIM(COPTD.UDF10) AS COPTDUDF10, 
(CASE WHEN COPTC.UDF09='否' THEN '' ELSE '是' END) X005, 
SUBSTRING(RTRIM(COPTC.TC003),1,4)+'-'+SUBSTRING(RTRIM(COPTC.TC003),5,2)+'-'+SUBSTRING(RTRIM(COPTC.TC003),7,2) AS COPTCTC003, 
(CASE WHEN K.TDUDF52 IS NOT NULL THEN '是' ELSE '' END) X007

FROM COPTD  
LEFT JOIN COPTC On COPTD.TD001=COPTC.TC001 and COPTD.TD002=COPTC.TC002 
LEFT JOIN COPTQ On COPTD.TD053=COPTQ.TQ002 and COPTD.TD004=COPTQ.TQ001 
LEFT JOIN COPMA On COPTC.TC004=COPMA.MA001 
LEFT JOIN CMSMV On COPTC.TC006=CMSMV.MV001 
LEFT JOIN INVMB ON COPTD.TD004=INVMB.MB001 
LEFT JOIN (
	SELECT TF001,TF002,TF104,TF017,TF003,UDF11,UDF51 
	FROM COPTF 
	WHERE COPTF.UDF08>='201806250000'
	AND COPTF.UDF08<='201806270000') X  
	On COPTD.TD001=X.TF001 and COPTD.TD002=X.TF002 AND COPTD.TD003=X.TF104 

LEFT JOIN (SELECT TD001 AS TDTD001, TD002 AS TDTD002, TD003 AS TDTD003, TD013 AS TDTD013, UDF52 AS TDUDF52 FROM COPTD) K 
	ON TDTD001 = TD001 AND TDTD002 = TD002 AND TDTD003 = TD003 
	AND CONVERT(INT, SUBSTRING(COPTD.CREATE_DATE, 1, 8)) = CONVERT(INT, TDUDF52) 
	AND CONVERT(INT, TD013) - CONVERT(INT, TDUDF52) <=2
WHERE 1=1 
AND (COPTC.TC027 = 'Y') 
AND COPTD.TD004 NOT LIKE '6%' 
AND COPTD.TD004 NOT LIKE '7%' 
AND (COPTD.UDF12>='201806250000' 
AND COPTD.UDF12<='201806270000') 
ORDER BY X002,COPTDTD013,TD001,TD002,TD003 
