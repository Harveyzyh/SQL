SELECT RTRIM(INVMB.MB001) INVMBMB001, RTRIM(INVMB.MB002) INVMBMB002, RTRIM(INVMB.MB003) INVMBMB003, CONVERT(FLOAT, INVMB.MB064) INVMBMB064, 
(CASE WHEN SC.SL IS NULL THEN 0 ELSE CONVERT(FLOAT, SC.SL) END) SCSL, (CASE WHEN SC.SL IS NULL THEN CONVERT(FLOAT, INVMB.MB064) ELSE CONVERT(FLOAT, (INVMB.MB064 - SC.SL)) END) KYSL, 
(CASE WHEN CG.SL IS NULL THEN 0 ELSE CONVERT(FLOAT, CG.SL) END) CGSL,INVMB.MB004 INVMBMB004 
FROM INVMB AS INVMB 
LEFT JOIN 
( 
	SELECT TD004 AS PH, SUM(PURTD.TD008 - PURTD.TD015) AS SL FROM PURTC AS PURTC 
	INNER JOIN PURTD AS PURTD ON PURTC.TC001 = PURTD.TD001 AND PURTC.TC002 = PURTD.TD002 
	WHERE 1=1 AND PURTC.TC014 = 'Y' AND PURTD.TD016 NOT IN ('Y', 'y') GROUP BY PURTD.TD004 
) AS CG ON CG.PH = INVMB.MB001 
LEFT JOIN 
( 
	SELECT MOCTE.TE004 AS PH, SUM(MOCTE.TE005) AS SL FROM MOCTE AS MOCTE 
	INNER JOIN MOCTC AS MOCTC ON MOCTC.TC001 = MOCTE.TE001 AND MOCTC.TC002 = MOCTE.TE002 
	WHERE 1=1 AND MOCTC.TC009 = 'N' 
	GROUP BY MOCTE.TE004 
) AS SC ON SC.PH = INVMB.MB001 
WHERE 1=1 
AND INVMB.MB034 = 'R' 
-- AND MB001 = '407010347'
ORDER BY INVMB.MB001 ASC 


