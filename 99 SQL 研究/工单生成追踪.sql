CREATE TABLE ATEST..Temp1_BOMTOCTO_123834178(LEVEL2 INT Null, MD003N VarChar(20) Null, MD006N DECIMAL(15,6) Null, MD007N INT, MD008N DECIMAL(5,4) Null, MD009N VARCHAR(4) NULL,
MD018N INT NULL, MD011N VARCHAR(8) NULL, MD012N VARCHAR(8) NULL, MD013N VARCHAR(1) NULL, MB065N DECIMAL(16,2) NULL, MB064N DECIMAL(17,6) NULL,
MB004N VARCHAR(4) NULL, MD014N VARCHAR(1) NULL, MD017N VARCHAR(1) NULL, MD019N VARCHAR(80) NULL, MD020N VARCHAR(80) NULL, MD021N VARCHAR(80) NULL,
MD022N VARCHAR(80) NULL, MD023N VARCHAR(80) NULL, MD016N VARCHAR(255) NULL, MD001U VARCHAR(20) NULL, MC004U DECIMAL(15,6) NULL, MC005U VARCHAR(4) NULL,
MC010U VARCHAR(255) NULL, MD002N VARCHAR(4) NULL, MB025N VARCHAR(1) NULL, LJZCYLN DECIMAL(16,6) NULL,
LJZCYLY DECIMAL(16,6) NULL,
PZXS VARCHAR(1) NULL, MB002N VARCHAR(60) NULL, MB003N VARCHAR(60) NULL, PZXH VARCHAR(4) NULL, MB072N VARCHAR(4) NULL, MB443N VARCHAR(1) NULL, MC017U VARCHAR(1) NULL, MC018U VARCHAR(1) NULL, 
MB002U VARCHAR(60) NULL, MB003U VARCHAR(60) NULL, MB004U VARCHAR(4) NULL, MB072U VARCHAR(4) NULL, MB025U VARCHAR(1) NULL, MD009Z VARCHAR(20 )NULL,  MD031N VARCHAR(1) NULL,  MD030N DECIMAL(16,6) NULL,  
MD032N VARCHAR(1) NULL  ,MD024N VARCHAR(1) NULL , TR200U VARCHAR(1200) NULL )


INSERT INTO ATEST..Temp1_BOMTOCTO_123834178 (LEVEL2,MD003N,MD006N,MD007N,MD008N,MD009N,MD018N,MD011N,MD012N,MD013N,
MB065N,MB064N,MB004N,MD014N,MD017N,MD019N,MD020N,MD021N,MD022N,MD023N,MD016N,
MD001U,MC004U,MC005U,MC010U,MD002N,MB025N,LJZCYLN,LJZCYLY,PZXS,MB002N,MB003N,PZXH, 
MB072N,MB443N,MC017U,MC018U,MB002U,MB003U,MB004U,MB072U,MB025U,MD009Z,MD031N,MD030N,MD032N  
,MD024N,TR200U) 
SELECT 0,MC001,1.000,1.000,0.0000,'',0,'','','',
0.00,0.000,'','','','','','','','','',
MC001,1.000,'','','','',1.000,1.000,'Y',INVMB.MB002,INVMB.MB003,'', 
'','',MC017,MC018,  INVMB.MB002,INVMB.MB003,INVMB.MB004,INVMB.MB072,INVMB.MB025,'','N',0,'0'  , 'Y'  ,
RIGHT('                    '+RTRIM(MC001),20)+ RIGHT('                    '+RTRIM(MC001),20)+'********00000000' FROM COMFORT.dbo.INVMB INVMB (NOLOCK) ,COMFORT.dbo.BOMMC BOMMC (NOLOCK) 
WHERE MB001=MC001 AND MC019='Y' AND MC001='10680101'


Alter Table ATEST..Temp1_BOMTOCTO_123834178 Add  LEVEL Varchar(255) Null


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET LEVEL='000' 


CREATE TABLE ATEST..Temp2_BOMTOCTO_123834178(ID_NUM int IDENTITY, LEVEL Varchar(255) Null, MD002 Char(4) Null, MD003 VarChar(20) Null, NEWID int Null, NEWLEVEL Varchar(255) Null, MB025 CHAR(1) Null )


INSERT INTO ATEST..Temp1_BOMTOCTO_123834178 (LEVEL,LEVEL2,MD003N,MD006N,MD007N,MD008N,MD009N,MD018N,MD011N,MD012N,MD013N,
MB065N,MB064N,MB004N,MD014N,MD017N,MD019N,MD020N,MD021N,MD022N,MD023N,MD016N,
MD001U,MC004U,MC005U,MC010U,MD002N,MB025N,LJZCYLN,LJZCYLY,PZXS,MB002N,MB003N,PZXH, 
MB072N,MB443N,MC017U,MC018U,MB002U,MB003U,MB004U,MB072U,MB025U,MD009Z,MD031N,MD030N,MD032N, MD024N,TR200U ) 
SELECT LEVEL,1 LEVEL2,MD003,MD006,MD007,MD008,MD009,MD018,MD011,MD012,MD013,
INVMB.MB065,INVMB.MB064,INVMB.MB004,MD014,MD017,MD019,MD020,MD021,MD022,MD023,MD016,
MD001,MC004,MC005,MC010,MD002,INVMB.MB025, 
A.LJZCYLN * MD006/MD007/MC004 AS LJZCYLN,A.LJZCYLY * MD006*(1+MD008)/MD007/MC004 AS LJZCYLY, 
(CASE WHEN A.PZXS='Y' AND A.MB025N<>'C' AND INVMB.MB025='C' THEN 'Y'  WHEN A.PZXS='Y' AND A.MB025N='C' THEN 'Y'  WHEN INVMB.MB025='C' THEN 'Y'  ELSE 'N' END ) PZXS,  
INVMB.MB002,INVMB.MB003,'',INVMB.MB072,INVMB.MB443,MC017,MC018,  INVMBU.MB002,INVMBU.MB003,INVMBU.MB004,INVMBU.MB072,INVMBU.MB025  ,CMSMW.MW002 ,MD031,MD030,MD032, BOMMD.MD024  ,
RIGHT('                    '+RTRIM(MC001),20)+ RIGHT('                    '+RTRIM(MD012),20)+MD002+RIGHT('****'+RTRIM(MD009),4)+RIGHT('99999999'+RTRIM(MD011),8) 
FROM COMFORT.dbo.BOMMC BOMMC (NOLOCK)  INNER JOIN ATEST..Temp1_BOMTOCTO_123834178 A ON A.MD003N=MC001  INNER JOIN COMFORT.dbo.INVMB INVMBU (NOLOCK) ON INVMBU.MB001=MC001  
INNER JOIN COMFORT.dbo.BOMMD BOMMD (NOLOCK) ON MC001=MD001  INNER JOIN COMFORT.dbo.INVMB INVMB (NOLOCK) ON INVMB.MB001=MD003  
LEFT  JOIN COMFORT.dbo.CMSMW CMSMW (NOLOCK) ON CMSMW.MW001=BOMMD.MD009  WHERE  LEVEL2=0
 
 
DELETE FROM ATEST..Temp2_BOMTOCTO_123834178
 
 
INSERT INTO ATEST..Temp2_BOMTOCTO_123834178(LEVEL,MD002,MD003,MB025)  SELECT LEVEL,MD002N,MD003N,MB025N FROM ATEST..Temp1_BOMTOCTO_123834178 WHERE LEVEL2=1 AND MB025N<>'P' 
ORDER BY LEVEL,MB025N,MD002N 

 
INSERT INTO ATEST..Temp2_BOMTOCTO_123834178(LEVEL,MD002,MD003,MB025)  SELECT LEVEL,MD002N,MD003N,MB025N FROM ATEST..Temp1_BOMTOCTO_123834178 WHERE LEVEL2=1 AND MB025N='P' 
ORDER BY LEVEL,MB025N,MD002N 


SELECT MIN(ID_NUM) ID_NUM3,LEVEL INTO ATEST..Temp3_BOMTOCTO_123834178 FROM ATEST..Temp2_BOMTOCTO_123834178 GROUP BY LEVEL 

-- 复制自增序号至新列
UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=ID_NUM-B.ID_NUM3  FROM ATEST..Temp2_BOMTOCTO_123834178 A,ATEST..Temp3_BOMTOCTO_123834178 B  WHERE A.LEVEL=B.LEVEL 

-- 更新上一条的序号装换为36进制， 第1位
UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))

-- 更新上一条的序号装换为36进制， 第2位
UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))

-- 更新上一条的序号装换为36进制， 第3位
UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET LEVEL=A.LEVEL + B.NEWLEVEL  FROM ATEST..Temp1_BOMTOCTO_123834178 A,ATEST..Temp2_BOMTOCTO_123834178 B 
WHERE A.LEVEL=B.LEVEL AND A.MD002N=B.MD002 AND A.MD003N=B.MD003 AND A.LEVEL2=1


DROP TABLE ATEST..Temp3_BOMTOCTO_123834178


INSERT INTO ATEST..Temp1_BOMTOCTO_123834178 (LEVEL,LEVEL2,MD003N,MD006N,MD007N,MD008N,MD009N,MD018N,MD011N,MD012N,MD013N,
MB065N,MB064N,MB004N,MD014N,MD017N,MD019N,MD020N,MD021N,MD022N,MD023N,MD016N,
MD001U,MC004U,MC005U,MC010U,MD002N,MB025N,LJZCYLN,LJZCYLY,PZXS,MB002N,MB003N,PZXH, 
MB072N,MB443N,MC017U,MC018U,MB002U,MB003U,MB004U,MB072U,MB025U,MD009Z,MD031N,MD030N,MD032N, MD024N,TR200U ) 
SELECT LEVEL,2 LEVEL2,MD003,MD006,MD007,MD008,MD009,MD018,MD011,MD012,MD013,
INVMB.MB065,INVMB.MB064,INVMB.MB004,MD014,MD017,MD019,MD020,MD021,MD022,MD023,MD016,
MD001,MC004,MC005,MC010,MD002,INVMB.MB025, 
A.LJZCYLN * MD006/MD007/MC004 AS LJZCYLN,A.LJZCYLY * MD006*(1+MD008)/MD007/MC004 AS LJZCYLY, 
(CASE WHEN A.PZXS='Y' AND A.MB025N<>'C' AND INVMB.MB025='C' THEN 'Y'  WHEN A.PZXS='Y' AND A.MB025N='C' THEN 'Y'  WHEN INVMB.MB025='C' THEN 'Y'  ELSE 'N' END ) PZXS,  
INVMB.MB002,INVMB.MB003,'',INVMB.MB072,INVMB.MB443,MC017,MC018,  INVMBU.MB002,INVMBU.MB003,INVMBU.MB004,INVMBU.MB072,INVMBU.MB025  ,CMSMW.MW002 ,MD031,MD030,MD032, BOMMD.MD024  ,
RIGHT('                    '+RTRIM(MC001),20)+ RIGHT('                    '+RTRIM(MD012),20)+MD002+RIGHT('****'+RTRIM(MD009),4)+RIGHT('99999999'+RTRIM(MD011),8) 
FROM COMFORT.dbo.BOMMC BOMMC (NOLOCK)  INNER JOIN ATEST..Temp1_BOMTOCTO_123834178 A ON A.MD003N=MC001  INNER JOIN COMFORT.dbo.INVMB INVMBU (NOLOCK) ON INVMBU.MB001=MC001  
INNER JOIN COMFORT.dbo.BOMMD BOMMD (NOLOCK) ON MC001=MD001  INNER JOIN COMFORT.dbo.INVMB INVMB (NOLOCK) ON INVMB.MB001=MD003  
LEFT  JOIN COMFORT.dbo.CMSMW CMSMW (NOLOCK) ON CMSMW.MW001=BOMMD.MD009  WHERE  LEVEL2=1


DELETE FROM ATEST..Temp2_BOMTOCTO_123834178


INSERT INTO ATEST..Temp2_BOMTOCTO_123834178(LEVEL,MD002,MD003,MB025)  SELECT LEVEL,MD002N,MD003N,MB025N FROM ATEST..Temp1_BOMTOCTO_123834178 WHERE LEVEL2=2 AND MB025N<>'P' ORDER BY LEVEL,MB025N,MD002N


INSERT INTO ATEST..Temp2_BOMTOCTO_123834178(LEVEL,MD002,MD003,MB025)  SELECT LEVEL,MD002N,MD003N,MB025N FROM ATEST..Temp1_BOMTOCTO_123834178 WHERE LEVEL2=2 AND MB025N='P' ORDER BY LEVEL,MB025N,MD002N


SELECT MIN(ID_NUM) ID_NUM3,LEVEL INTO ATEST..Temp3_BOMTOCTO_123834178 FROM ATEST..Temp2_BOMTOCTO_123834178 GROUP BY LEVEL


UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=ID_NUM-B.ID_NUM3  FROM ATEST..Temp2_BOMTOCTO_123834178 A,ATEST..Temp3_BOMTOCTO_123834178 B  WHERE A.LEVEL=B.LEVEL


UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET LEVEL=A.LEVEL + B.NEWLEVEL  FROM ATEST..Temp1_BOMTOCTO_123834178 A,ATEST..Temp2_BOMTOCTO_123834178 B WHERE A.LEVEL=B.LEVEL AND A.MD002N=B.MD002 AND A.MD003N=B.MD003 AND A.LEVEL2=2


SELECT DISTINCT A.LEVEL  FROM ATEST..Temp2_BOMTOCTO_123834178 AS A  LEFT JOIN ATEST..Temp1_BOMTOCTO_123834178 AS B ON A.LEVEL=B.LEVEL  WHERE MB025='C' AND PZXS<>'Y'


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('000007' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('000007' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000A' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000A' )


SELECT DISTINCT A.LEVEL,PZXS  FROM ATEST..Temp2_BOMTOCTO_123834178 AS A  LEFT JOIN ATEST..Temp1_BOMTOCTO_123834178 AS B ON A.LEVEL=B.LEVEL  WHERE MB025='C'


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('000007' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000A' )


DROP TABLE ATEST..Temp3_BOMTOCTO_123834178


INSERT INTO ATEST..Temp1_BOMTOCTO_123834178 (LEVEL,LEVEL2,MD003N,MD006N,MD007N,MD008N,MD009N,MD018N,MD011N,MD012N,MD013N,
MB065N,MB064N,MB004N,MD014N,MD017N,MD019N,MD020N,MD021N,MD022N,MD023N,MD016N,
MD001U,MC004U,MC005U,MC010U,MD002N,MB025N,LJZCYLN,LJZCYLY,PZXS,MB002N,MB003N,PZXH, 
MB072N,MB443N,MC017U,MC018U,MB002U,MB003U,MB004U,MB072U,MB025U,MD009Z,MD031N,MD030N,MD032N, MD024N,TR200U ) 
SELECT LEVEL,3 LEVEL2,MD003,MD006,MD007,MD008,MD009,MD018,MD011,MD012,MD013,
INVMB.MB065,INVMB.MB064,INVMB.MB004,MD014,MD017,MD019,MD020,MD021,MD022,MD023,MD016,
MD001,MC004,MC005,MC010,MD002,INVMB.MB025, 
A.LJZCYLN * MD006/MD007/MC004 AS LJZCYLN,A.LJZCYLY * MD006*(1+MD008)/MD007/MC004 AS LJZCYLY, 
(CASE WHEN A.PZXS='Y' AND A.MB025N<>'C' AND INVMB.MB025='C' THEN 'Y'  WHEN A.PZXS='Y' AND A.MB025N='C' THEN 'Y'  WHEN INVMB.MB025='C' THEN 'Y'  ELSE 'N' END ) PZXS,  
INVMB.MB002,INVMB.MB003,'',INVMB.MB072,INVMB.MB443,MC017,MC018,  INVMBU.MB002,INVMBU.MB003,INVMBU.MB004,INVMBU.MB072,INVMBU.MB025  ,CMSMW.MW002 ,MD031,MD030,MD032, BOMMD.MD024  ,
RIGHT('                    '+RTRIM(MC001),20)+ RIGHT('                    '+RTRIM(MD012),20)+MD002+RIGHT('****'+RTRIM(MD009),4)+RIGHT('99999999'+RTRIM(MD011),8) 
FROM COMFORT.dbo.BOMMC BOMMC (NOLOCK)  INNER JOIN ATEST..Temp1_BOMTOCTO_123834178 A ON A.MD003N=MC001  INNER JOIN COMFORT.dbo.INVMB INVMBU (NOLOCK) ON INVMBU.MB001=MC001  
INNER JOIN COMFORT.dbo.BOMMD BOMMD (NOLOCK) ON MC001=MD001  INNER JOIN COMFORT.dbo.INVMB INVMB (NOLOCK) ON INVMB.MB001=MD003  
LEFT  JOIN COMFORT.dbo.CMSMW CMSMW (NOLOCK) ON CMSMW.MW001=BOMMD.MD009  WHERE  LEVEL2=2


DELETE FROM ATEST..Temp2_BOMTOCTO_123834178


INSERT INTO ATEST..Temp2_BOMTOCTO_123834178(LEVEL,MD002,MD003,MB025)  SELECT LEVEL,MD002N,MD003N,MB025N FROM ATEST..Temp1_BOMTOCTO_123834178 WHERE LEVEL2=3 AND MB025N<>'P' ORDER BY LEVEL,MB025N,MD002N


INSERT INTO ATEST..Temp2_BOMTOCTO_123834178(LEVEL,MD002,MD003,MB025)  SELECT LEVEL,MD002N,MD003N,MB025N FROM ATEST..Temp1_BOMTOCTO_123834178 WHERE LEVEL2=3 AND MB025N='P' ORDER BY LEVEL,MB025N,MD002N


SELECT MIN(ID_NUM) ID_NUM3,LEVEL INTO ATEST..Temp3_BOMTOCTO_123834178 FROM ATEST..Temp2_BOMTOCTO_123834178 GROUP BY LEVEL


UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=ID_NUM-B.ID_NUM3  FROM ATEST..Temp2_BOMTOCTO_123834178 A,ATEST..Temp3_BOMTOCTO_123834178 B  WHERE A.LEVEL=B.LEVEL


UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET LEVEL=A.LEVEL + B.NEWLEVEL  FROM ATEST..Temp1_BOMTOCTO_123834178 A,ATEST..Temp2_BOMTOCTO_123834178 B WHERE A.LEVEL=B.LEVEL AND A.MD002N=B.MD002 AND A.MD003N=B.MD003 AND A.LEVEL2=3


SELECT DISTINCT A.LEVEL  FROM ATEST..Temp2_BOMTOCTO_123834178 AS A  LEFT JOIN ATEST..Temp1_BOMTOCTO_123834178 AS B ON A.LEVEL=B.LEVEL  WHERE MB025='C' AND PZXS<>'Y'


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000B000','00000B' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000C000','00000C' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000D000','00000D' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000E000','00000E' )


SELECT DISTINCT A.LEVEL,PZXS  FROM ATEST..Temp2_BOMTOCTO_123834178 AS A  LEFT JOIN ATEST..Temp1_BOMTOCTO_123834178 AS B ON A.LEVEL=B.LEVEL  WHERE MB025='C'


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('000000000','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000N','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000O','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000P','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000Q','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000U','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000W','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000Y','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('000000017','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('000000019','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000001A','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000001B','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000001C','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000001E','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000001F','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000B000','00000B' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000C000','00000C' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000D000','00000D' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000E000','00000E' )


DROP TABLE ATEST..Temp3_BOMTOCTO_123834178


INSERT INTO ATEST..Temp1_BOMTOCTO_123834178 (LEVEL,LEVEL2,MD003N,MD006N,MD007N,MD008N,MD009N,MD018N,MD011N,MD012N,MD013N,
MB065N,MB064N,MB004N,MD014N,MD017N,MD019N,MD020N,MD021N,MD022N,MD023N,MD016N,
MD001U,MC004U,MC005U,MC010U,MD002N,MB025N,LJZCYLN,LJZCYLY,PZXS,MB002N,MB003N,PZXH, 
MB072N,MB443N,MC017U,MC018U,MB002U,MB003U,MB004U,MB072U,MB025U,MD009Z,MD031N,MD030N,MD032N, MD024N,TR200U ) 
SELECT LEVEL,4 LEVEL2,MD003,MD006,MD007,MD008,MD009,MD018,MD011,MD012,MD013,
INVMB.MB065,INVMB.MB064,INVMB.MB004,MD014,MD017,MD019,MD020,MD021,MD022,MD023,MD016,
MD001,MC004,MC005,MC010,MD002,INVMB.MB025, 
A.LJZCYLN * MD006/MD007/MC004 AS LJZCYLN,A.LJZCYLY * MD006*(1+MD008)/MD007/MC004 AS LJZCYLY, 
(CASE WHEN A.PZXS='Y' AND A.MB025N<>'C' AND INVMB.MB025='C' THEN 'Y'  WHEN A.PZXS='Y' AND A.MB025N='C' THEN 'Y'  WHEN INVMB.MB025='C' THEN 'Y'  ELSE 'N' END ) PZXS,  
INVMB.MB002,INVMB.MB003,'',INVMB.MB072,INVMB.MB443,MC017,MC018,  INVMBU.MB002,INVMBU.MB003,INVMBU.MB004,INVMBU.MB072,INVMBU.MB025  ,CMSMW.MW002 ,MD031,MD030,MD032, BOMMD.MD024  ,
RIGHT('                    '+RTRIM(MC001),20)+ RIGHT('                    '+RTRIM(MD012),20)+MD002+RIGHT('****'+RTRIM(MD009),4)+RIGHT('99999999'+RTRIM(MD011),8) 
FROM COMFORT.dbo.BOMMC BOMMC (NOLOCK)  INNER JOIN ATEST..Temp1_BOMTOCTO_123834178 A ON A.MD003N=MC001  INNER JOIN COMFORT.dbo.INVMB INVMBU (NOLOCK) ON INVMBU.MB001=MC001  
INNER JOIN COMFORT.dbo.BOMMD BOMMD (NOLOCK) ON MC001=MD001  INNER JOIN COMFORT.dbo.INVMB INVMB (NOLOCK) ON INVMB.MB001=MD003  
LEFT  JOIN COMFORT.dbo.CMSMW CMSMW (NOLOCK) ON CMSMW.MW001=BOMMD.MD009  WHERE  LEVEL2=3


DELETE FROM ATEST..Temp2_BOMTOCTO_123834178


INSERT INTO ATEST..Temp2_BOMTOCTO_123834178(LEVEL,MD002,MD003,MB025)  SELECT LEVEL,MD002N,MD003N,MB025N FROM ATEST..Temp1_BOMTOCTO_123834178 WHERE LEVEL2=4 AND MB025N<>'P' ORDER BY LEVEL,MB025N,MD002N


SELECT MIN(ID_NUM) ID_NUM3,LEVEL INTO ATEST..Temp3_BOMTOCTO_123834178 FROM ATEST..Temp2_BOMTOCTO_123834178 GROUP BY LEVEL


UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=ID_NUM-B.ID_NUM3  FROM ATEST..Temp2_BOMTOCTO_123834178 A,ATEST..Temp3_BOMTOCTO_123834178 B  WHERE A.LEVEL=B.LEVEL


UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET LEVEL=A.LEVEL + B.NEWLEVEL  FROM ATEST..Temp1_BOMTOCTO_123834178 A,ATEST..Temp2_BOMTOCTO_123834178 B WHERE A.LEVEL=B.LEVEL AND A.MD002N=B.MD002 AND A.MD003N=B.MD003 AND A.LEVEL2=4


SELECT DISTINCT A.LEVEL  FROM ATEST..Temp2_BOMTOCTO_123834178 AS A  LEFT JOIN ATEST..Temp1_BOMTOCTO_123834178 AS B ON A.LEVEL=B.LEVEL  WHERE MB025='C' AND PZXS<>'Y'


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('000000000001','000000000','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('000000001000','000000001','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('000000003000','000000003','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('000000005000','000000005','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('000000006000','000000006','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('000000008000','000000008','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('000000009000','000000009','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000A000','00000000A','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000B000','00000000B','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000C000','00000000C','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000E000','00000000E','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000F000','00000000F','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000H000','00000000H','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000I000','00000000I','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000J000','00000000J','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000K001','00000000K','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000M000','00000000M','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000N001','00000000N','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000O002','00000000O','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000P001','00000000P','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000Q001','00000000Q','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000R000','00000000R','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000S000','00000000S','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000T000','00000000T','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000U003','00000000U','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000V000','00000000V','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000000W001','00000000W','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('000000012000','000000012','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('000000019001','000000019','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000001A001','00000001A','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000001B001','00000001B','000000' )


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXS='Y'  WHERE LEVEL IN ('00000001D000','00000001D','000000' )


SELECT DISTINCT A.LEVEL,PZXS  FROM ATEST..Temp2_BOMTOCTO_123834178 AS A  LEFT JOIN ATEST..Temp1_BOMTOCTO_123834178 AS B ON A.LEVEL=B.LEVEL  WHERE MB025='C'


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('000000000001','000000000','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('000000001000','000000001','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('000000003000','000000003','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('000000005000','000000005','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('000000006000','000000006','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('000000008000','000000008','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('000000009000','000000009','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000A000','00000000A','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000B000','00000000B','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000C000','00000000C','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000E000','00000000E','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000F000','00000000F','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000H000','00000000H','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000I000','00000000I','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000J000','00000000J','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000K001','00000000K','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000M000','00000000M','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000N001','00000000N','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000O002','00000000O','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000P001','00000000P','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000Q001','00000000Q','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000R000','00000000R','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000S000','00000000S','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000T000','00000000T','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000U003','00000000U','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000V000','00000000V','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000000W001','00000000W','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('000000012000','000000012','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('000000019001','000000019','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000001A001','00000001A','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000001B001','00000001B','000000' )
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='Y'  WHERE LEVEL IN ('00000001D000','00000001D','000000' )


DROP TABLE ATEST..Temp3_BOMTOCTO_123834178


INSERT INTO ATEST..Temp1_BOMTOCTO_123834178 (LEVEL,LEVEL2,MD003N,MD006N,MD007N,MD008N,MD009N,MD018N,MD011N,MD012N,MD013N,
MB065N,MB064N,MB004N,MD014N,MD017N,MD019N,MD020N,MD021N,MD022N,MD023N,MD016N,
MD001U,MC004U,MC005U,MC010U,MD002N,MB025N,LJZCYLN,LJZCYLY,PZXS,MB002N,MB003N,PZXH, 
MB072N,MB443N,MC017U,MC018U,MB002U,MB003U,MB004U,MB072U,MB025U,MD009Z,MD031N,MD030N,MD032N, MD024N,TR200U ) 
SELECT LEVEL,5 LEVEL2,MD003,MD006,MD007,MD008,MD009,MD018,MD011,MD012,MD013,
INVMB.MB065,INVMB.MB064,INVMB.MB004,MD014,MD017,MD019,MD020,MD021,MD022,MD023,MD016,
MD001,MC004,MC005,MC010,MD002,INVMB.MB025, 
A.LJZCYLN * MD006/MD007/MC004 AS LJZCYLN,A.LJZCYLY * MD006*(1+MD008)/MD007/MC004 AS LJZCYLY, 
(CASE WHEN A.PZXS='Y' AND A.MB025N<>'C' AND INVMB.MB025='C' THEN 'Y'  WHEN A.PZXS='Y' AND A.MB025N='C' THEN 'Y'  WHEN INVMB.MB025='C' THEN 'Y'  ELSE 'N' END ) PZXS,  
INVMB.MB002,INVMB.MB003,'',INVMB.MB072,INVMB.MB443,MC017,MC018,  INVMBU.MB002,INVMBU.MB003,INVMBU.MB004,INVMBU.MB072,INVMBU.MB025  ,CMSMW.MW002 ,MD031,MD030,MD032, BOMMD.MD024  ,
RIGHT('                    '+RTRIM(MC001),20)+ RIGHT('                    '+RTRIM(MD012),20)+MD002+RIGHT('****'+RTRIM(MD009),4)+RIGHT('99999999'+RTRIM(MD011),8) 
FROM COMFORT.dbo.BOMMC BOMMC (NOLOCK)  INNER JOIN ATEST..Temp1_BOMTOCTO_123834178 A ON A.MD003N=MC001  INNER JOIN COMFORT.dbo.INVMB INVMBU (NOLOCK) ON INVMBU.MB001=MC001  
INNER JOIN COMFORT.dbo.BOMMD BOMMD (NOLOCK) ON MC001=MD001  INNER JOIN COMFORT.dbo.INVMB INVMB (NOLOCK) ON INVMB.MB001=MD003  
LEFT  JOIN COMFORT.dbo.CMSMW CMSMW (NOLOCK) ON CMSMW.MW001=BOMMD.MD009  WHERE  LEVEL2=4


DELETE FROM ATEST..Temp2_BOMTOCTO_123834178


INSERT INTO ATEST..Temp2_BOMTOCTO_123834178(LEVEL,MD002,MD003,MB025)  SELECT LEVEL,MD002N,MD003N,MB025N FROM ATEST..Temp1_BOMTOCTO_123834178 WHERE LEVEL2=5 AND MB025N<>'P' ORDER BY LEVEL,MB025N,MD002N


INSERT INTO ATEST..Temp2_BOMTOCTO_123834178(LEVEL,MD002,MD003,MB025)  SELECT LEVEL,MD002N,MD003N,MB025N FROM ATEST..Temp1_BOMTOCTO_123834178 WHERE LEVEL2=5 AND MB025N='P' ORDER BY LEVEL,MB025N,MD002N


SELECT MIN(ID_NUM) ID_NUM3,LEVEL INTO ATEST..Temp3_BOMTOCTO_123834178 FROM ATEST..Temp2_BOMTOCTO_123834178 GROUP BY LEVEL


UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=ID_NUM-B.ID_NUM3  FROM ATEST..Temp2_BOMTOCTO_123834178 A,ATEST..Temp3_BOMTOCTO_123834178 B  WHERE A.LEVEL=B.LEVEL


UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Temp2_BOMTOCTO_123834178 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET LEVEL=A.LEVEL + B.NEWLEVEL  FROM ATEST..Temp1_BOMTOCTO_123834178 A,ATEST..Temp2_BOMTOCTO_123834178 B WHERE A.LEVEL=B.LEVEL AND A.MD002N=B.MD002 AND A.MD003N=B.MD003 AND A.LEVEL2=5


SELECT DISTINCT A.LEVEL  FROM ATEST..Temp2_BOMTOCTO_123834178 AS A  LEFT JOIN ATEST..Temp1_BOMTOCTO_123834178 AS B ON A.LEVEL=B.LEVEL  WHERE MB025='C' AND PZXS<>'Y'


SELECT DISTINCT A.LEVEL,PZXS  FROM ATEST..Temp2_BOMTOCTO_123834178 AS A  LEFT JOIN ATEST..Temp1_BOMTOCTO_123834178 AS B ON A.LEVEL=B.LEVEL  WHERE MB025='C'


DROP TABLE ATEST..Temp3_BOMTOCTO_123834178


INSERT INTO ATEST..Temp1_BOMTOCTO_123834178 (LEVEL,LEVEL2,MD003N,MD006N,MD007N,MD008N,MD009N,MD018N,MD011N,MD012N,MD013N,
MB065N,MB064N,MB004N,MD014N,MD017N,MD019N,MD020N,MD021N,MD022N,MD023N,MD016N,
MD001U,MC004U,MC005U,MC010U,MD002N,MB025N,LJZCYLN,LJZCYLY,PZXS,MB002N,MB003N,PZXH, 
MB072N,MB443N,MC017U,MC018U,MB002U,MB003U,MB004U,MB072U,MB025U,MD009Z,MD031N,MD030N,MD032N, MD024N,TR200U ) 
SELECT LEVEL,6 LEVEL2,MD003,MD006,MD007,MD008,MD009,MD018,MD011,MD012,MD013,
INVMB.MB065,INVMB.MB064,INVMB.MB004,MD014,MD017,MD019,MD020,MD021,MD022,MD023,MD016,
MD001,MC004,MC005,MC010,MD002,INVMB.MB025, 
A.LJZCYLN * MD006/MD007/MC004 AS LJZCYLN,A.LJZCYLY * MD006*(1+MD008)/MD007/MC004 AS LJZCYLY, 
(CASE WHEN A.PZXS='Y' AND A.MB025N<>'C' AND INVMB.MB025='C' THEN 'Y'  WHEN A.PZXS='Y' AND A.MB025N='C' THEN 'Y'  WHEN INVMB.MB025='C' THEN 'Y'  ELSE 'N' END ) PZXS,  
INVMB.MB002,INVMB.MB003,'',INVMB.MB072,INVMB.MB443,MC017,MC018,  INVMBU.MB002,INVMBU.MB003,INVMBU.MB004,INVMBU.MB072,INVMBU.MB025  ,CMSMW.MW002 ,MD031,MD030,MD032, BOMMD.MD024  ,
RIGHT('                    '+RTRIM(MC001),20)+ RIGHT('                    '+RTRIM(MD012),20)+MD002+RIGHT('****'+RTRIM(MD009),4)+RIGHT('99999999'+RTRIM(MD011),8) 
FROM COMFORT.dbo.BOMMC BOMMC (NOLOCK)  INNER JOIN ATEST..Temp1_BOMTOCTO_123834178 A ON A.MD003N=MC001  INNER JOIN COMFORT.dbo.INVMB INVMBU (NOLOCK) ON INVMBU.MB001=MC001  
INNER JOIN COMFORT.dbo.BOMMD BOMMD (NOLOCK) ON MC001=MD001  INNER JOIN COMFORT.dbo.INVMB INVMB (NOLOCK) ON INVMB.MB001=MD003  
LEFT  JOIN COMFORT.dbo.CMSMW CMSMW (NOLOCK) ON CMSMW.MW001=BOMMD.MD009  WHERE  LEVEL2=5


SELECT LEVEL FROM ATEST..Temp1_BOMTOCTO_123834178 WHERE PZXH='Y' ORDER BY LEN(LEVEL),LEVEL


UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0000' WHERE LEVEL='000000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0001' WHERE LEVEL='000007'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0002' WHERE LEVEL='00000A'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0003' WHERE LEVEL='00000B'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0004' WHERE LEVEL='00000C'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0005' WHERE LEVEL='00000D'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0006' WHERE LEVEL='00000E'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0007' WHERE LEVEL='000000000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0008' WHERE LEVEL='000000001'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0009' WHERE LEVEL='000000003'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0010' WHERE LEVEL='000000005'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0011' WHERE LEVEL='000000006'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0012' WHERE LEVEL='000000008'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0013' WHERE LEVEL='000000009'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0014' WHERE LEVEL='00000000A'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0015' WHERE LEVEL='00000000B'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0016' WHERE LEVEL='00000000C'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0017' WHERE LEVEL='00000000E'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0018' WHERE LEVEL='00000000F'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0019' WHERE LEVEL='00000000H'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0020' WHERE LEVEL='00000000I'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0021' WHERE LEVEL='00000000J'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0022' WHERE LEVEL='00000000K'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0023' WHERE LEVEL='00000000M'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0024' WHERE LEVEL='00000000N'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0025' WHERE LEVEL='00000000O'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0026' WHERE LEVEL='00000000P'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0027' WHERE LEVEL='00000000Q'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0028' WHERE LEVEL='00000000R'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0029' WHERE LEVEL='00000000S'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0030' WHERE LEVEL='00000000T'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0031' WHERE LEVEL='00000000U'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0032' WHERE LEVEL='00000000V'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0033' WHERE LEVEL='00000000W'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0034' WHERE LEVEL='00000000Y'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0035' WHERE LEVEL='000000012'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0036' WHERE LEVEL='000000017'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0037' WHERE LEVEL='000000019'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0038' WHERE LEVEL='00000001A'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0039' WHERE LEVEL='00000001B'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0040' WHERE LEVEL='00000001C'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0041' WHERE LEVEL='00000001D'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0042' WHERE LEVEL='00000001E'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0043' WHERE LEVEL='00000001F'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0044' WHERE LEVEL='00000B000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0045' WHERE LEVEL='00000C000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0046' WHERE LEVEL='00000D000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0047' WHERE LEVEL='00000E000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0048' WHERE LEVEL='000000000001'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0049' WHERE LEVEL='000000001000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0050' WHERE LEVEL='000000003000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0051' WHERE LEVEL='000000005000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0052' WHERE LEVEL='000000006000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0053' WHERE LEVEL='000000008000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0054' WHERE LEVEL='000000009000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0055' WHERE LEVEL='00000000A000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0056' WHERE LEVEL='00000000B000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0057' WHERE LEVEL='00000000C000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0058' WHERE LEVEL='00000000E000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0059' WHERE LEVEL='00000000F000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0060' WHERE LEVEL='00000000H000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0061' WHERE LEVEL='00000000I000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0062' WHERE LEVEL='00000000J000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0063' WHERE LEVEL='00000000K001'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0064' WHERE LEVEL='00000000M000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0065' WHERE LEVEL='00000000N001'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0066' WHERE LEVEL='00000000O002'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0067' WHERE LEVEL='00000000P001'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0068' WHERE LEVEL='00000000Q001'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0069' WHERE LEVEL='00000000R000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0070' WHERE LEVEL='00000000S000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0071' WHERE LEVEL='00000000T000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0072' WHERE LEVEL='00000000U003'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0073' WHERE LEVEL='00000000V000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0074' WHERE LEVEL='00000000W001'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0075' WHERE LEVEL='000000012000'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0076' WHERE LEVEL='000000019001'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0077' WHERE LEVEL='00000001A001'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0078' WHERE LEVEL='00000001B001'
UPDATE ATEST..Temp1_BOMTOCTO_123834178 SET PZXH='0079' WHERE LEVEL='00000001D000'


SELECT ATEST..Temp1_BOMTOCTO_123834178.* FROM ATEST..Temp1_BOMTOCTO_123834178 ORDER BY LEVEL ASC


SELECT * INTO ATEST..Temp4_BOMTOCTO_123834178 FROM COMFORT.dbo.COPTR WHERE 1=2


INSERT INTO ATEST..Temp4_BOMTOCTO_123834178 (TR001,TR002,TR003,TR004,TR005,TR006,TR007,TR008,TR009,TR010, TR011,TR012,TR013,TR014,TR015,TR016,TR017,TR018,TR019,TR020, 
TR021,TR022,TR023,TR024,TR025,TR026,TR027,TR030,TR031,TR032,TR200) 
SELECT '10680101','B01 W09-01黑 120行程r滑轮',LEVEL,MD001U,MC004U,MC005U,MC010U,'N',MD003N,MD006N, MD007N,MD008N,MD009N,MD018N,MD011N,MD012N,MD013N,
(CASE WHEN MB065N IS NULL THEN 0 ELSE MB065N END)  /(CASE WHEN MB064N=0 THEN 1 ELSE MB064N END),MD014N,'N',MD017N, MD019N,MD020N,MD021N,MD022N,MD023N,MD016N,MD002N,PZXS,PZXH,TR200U  
FROM ATEST..Temp1_BOMTOCTO_123834178


UPDATE A  SET A.TR004=B.TR004 ,A.TR005=B.TR005 ,A.TR006=B.TR006 ,A.TR007=B.TR007 ,A.TR008=B.TR008 ,     A.TR009=B.TR009 ,A.TR010=B.TR010 ,A.TR011=B.TR011 ,A.TR012=B.TR012 ,A.TR013=B.TR013 ,     
A.TR014=B.TR014 ,A.TR015=B.TR015 ,A.TR016=B.TR016 ,A.TR017=B.TR017 ,A.TR018=B.TR018 ,     A.TR019=B.TR019 ,A.TR020=B.TR020 ,A.TR021=B.TR021 ,A.TR022=B.TR022 ,A.TR023=B.TR023 ,     
A.TR024=B.TR024 ,A.TR025=B.TR025 ,A.TR026=B.TR026 ,A.TR027=B.TR027 ,A.TR030=B.TR030 ,     A.TR031=B.TR031 ,A.TR032=B.TR032 ,A.TR200=B.TR200       
FROM ATEST..Temp4_BOMTOCTO_123834178 A,COMFORT.dbo.COPTR  B  WHERE B.TR001='10680101' AND B.TR002='B01 W09-01黑 120行程r滑轮' AND A.TR003=B.TR003


DROP TABLE ATEST..Temp1_BOMTOCTO_123834178


DROP TABLE ATEST..Temp2_BOMTOCTO_123834178


-- DROP TABLE ATEST..Temp3_BOMTOCTO_123834178


-- DROP TABLE ATEST..Table1_CTOBomExtract_123841402


-- DROP TABLE ATEST..Table2_CTOBomExtract_123841402


-- DROP TABLE ATEST..Table3_CTOBomExtract_123841402


-- DROP TABLE ATEST..Query1_CTOBomExtract_123841402


CREATE TABLE ATEST..Table2_CTOBomExtract_123841402(ID_NUM int IDENTITY, LEVEL Varchar(255) Null, MD002 Char(4) Null, MD003 VarChar(20) Null, NEWID int Null, NEWLEVEL Varchar(255) Null)


SELECT TOP 1 TR009,TR030,TR001,TR028,TR029,TR007,TR004,TR013,TR006,MB026,
MB002,MB003,MB004,MB072,MB017,TR021,MB022,MB066,TR014,MB041,
MC003,' ' Redata,MC002,MW002,MB090,MB091,TR015,TR016,TR028 LSZCYL,TR029 LSSJYL,
MB034,MB025,MB032,MB036,MB037,MB038,MB039,MB040,MB068,MB076,
MB111,MB148,MB149,TR002,TR032,MB443,0 AS LEVEL2,TR017,TR003
,MB438,MB042 
,TR041, TR033,MB109 
INTO ATEST..Table1_CTOBomExtract_123841402
FROM ATEST..Temp4_BOMTOCTO_123834178 B 
LEFT JOIN COMFORT.dbo.INVMB D (NOLOCK) ON MB001=TR009 
LEFT JOIN COMFORT.dbo.CMSMC C (NOLOCK) ON MC001=MB017 
LEFT JOIN COMFORT.dbo.CMSMW E (NOLOCK) ON MW001=TR013 
WHERE TR009='10680101' AND TR002='B01 W09-01黑 120行程r滑轮'
AND ((TR032='') OR (TR032='')) 
AND TR001='10680101'


Alter Table ATEST..Table1_CTOBomExtract_123841402 Add  LEVEL Varchar(255) Null


UPDATE ATEST..Table1_CTOBomExtract_123841402 SET LEVEL='000',TR028=1.000,TR029=1.000


SELECT MB443,TR001 FROM ATEST..Temp4_BOMTOCTO_123834178 INNER JOIN COMFORT.dbo.INVMB (NOLOCK) ON MB001=TR001 WHERE TR009='10680101' AND TR002='B01 W09-01黑 120行程r滑轮' AND TR001='10680101'


INSERT INTO ATEST..Table1_CTOBomExtract_123841402( LEVEL,TR009,TR030,TR001,TR028,TR029,TR007,TR004,TR013,TR006,MB026,
MB002,MB003,MB004,MB072,MB017,TR021,MB022,MB066,TR014,MB041,
MC003,Redata,MC002,MW002,MB090,MB091,TR015,TR016,LSZCYL,LSSJYL,
MB034,MB025,MB032,MB036,MB037,MB038,MB039,MB040,MB068,MB076,
MB111,MB148,MB149,TR002,TR032,MB443,LEVEL2,TR017,TR003,MB438,MB042 
,TR041,TR033,MB109) 
SELECT F.LEVEL,B.TR009,B.TR030,B.TR001,
F.TR028*B.TR010/B.TR011/TR005, F.TR029*B.TR010*(1+B.TR012)/B.TR011/B.TR005,B.TR007,B.TR004,B.TR013,B.TR006,D.MB026,
D.MB002,D.MB003,D.MB004,D.MB072,D.MB017,B.TR021,D.MB022,D.MB066,B.TR014,D.MB041,
C.MC003,' ' Redata,C.MC002,E.MW002,D.MB090,D.MB091,B.TR015,B.TR016,B.TR028,B.TR029,
D.MB034,D.MB025,D.MB032,D.MB036,D.MB037,D.MB038,D.MB039,D.MB040,D.MB068,D.MB076,
D.MB111,D.MB148,D.MB149,B.TR002,B.TR032,D.MB443,LEVEL2=1,B.TR017,B.TR003 
,D.MB438,D.MB042 
,B.TR041 
, B.TR033,D.MB109  
FROM ATEST..Temp4_BOMTOCTO_123834178 B 
LEFT JOIN COMFORT.dbo.INVMB D (NOLOCK) ON D.MB001=B.TR009 
LEFT JOIN COMFORT.dbo.CMSMC C (NOLOCK) ON C.MC001=D.MB017 
LEFT JOIN COMFORT.dbo.CMSMW E (NOLOCK) ON E.MW001=B.TR013 
INNER JOIN ATEST..Table1_CTOBomExtract_123841402 F ON LTRIM(F.TR003)=LEFT(B.TR003,LEN(LTRIM(B.TR003))-3) AND F.TR009=B.TR004 AND B.TR009<>B.TR001 
WHERE F.LEVEL2=0
AND B.TR002='B01 W09-01黑 120行程r滑轮'
AND B.TR001='10680101'
AND (NOT (F.MB025 IN ('C') AND B.TR017='N')) 
AND ((B.TR015<='20190904' OR B.TR015='' OR B.TR015 IS NULL) 
AND (B.TR016='' OR B.TR016 IS NULL OR B.TR016>'20190904'))


DELETE FROM ATEST..Table2_CTOBomExtract_123841402


INSERT INTO ATEST..Table2_CTOBomExtract_123841402(LEVEL,MD002,MD003)  SELECT LEVEL,TR030,TR009 FROM ATEST..Table1_CTOBomExtract_123841402 WHERE LEVEL2=1 ORDER BY LEVEL,TR030


SELECT MIN(ID_NUM) ID_NUM3,LEVEL INTO ATEST..Table3_CTOBomExtract_123841402 FROM ATEST..Table2_CTOBomExtract_123841402 GROUP BY LEVEL


UPDATE ATEST..Table2_CTOBomExtract_123841402 SET NEWID=ID_NUM-B.ID_NUM3  FROM ATEST..Table2_CTOBomExtract_123841402 A,ATEST..Table3_CTOBomExtract_123841402 B  WHERE A.LEVEL=B.LEVEL


UPDATE ATEST..Table2_CTOBomExtract_123841402 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Table2_CTOBomExtract_123841402 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Table2_CTOBomExtract_123841402 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Table1_CTOBomExtract_123841402 SET LEVEL=LTRIM(A.LEVEL) + B.NEWLEVEL  
FROM ATEST..Table1_CTOBomExtract_123841402 A,ATEST..Table2_CTOBomExtract_123841402 B WHERE A.LEVEL=B.LEVEL AND A.TR030=B.MD002 AND A.TR009=B.MD003 AND A.LEVEL2=1 AND ((1=2 AND LEN(A.LEVEL)<>9) OR 1<>2 )


DROP TABLE ATEST..Table3_CTOBomExtract_123841402


INSERT INTO ATEST..Table1_CTOBomExtract_123841402( LEVEL,TR009,TR030,TR001,TR028,TR029,TR007,TR004,TR013,TR006,MB026,
MB002,MB003,MB004,MB072,MB017,TR021,MB022,MB066,TR014,MB041,
MC003,Redata,MC002,MW002,MB090,MB091,TR015,TR016,LSZCYL,LSSJYL,
MB034,MB025,MB032,MB036,MB037,MB038,MB039,MB040,MB068,MB076,
MB111,MB148,MB149,TR002,TR032,MB443,LEVEL2,TR017,TR003,MB438,MB042 
,TR041,TR033,MB109) 
SELECT F.LEVEL,B.TR009,B.TR030,B.TR001,
F.TR028*B.TR010/B.TR011/TR005, F.TR029*B.TR010*(1+B.TR012)/B.TR011/B.TR005,B.TR007,B.TR004,B.TR013,B.TR006,D.MB026,
D.MB002,D.MB003,D.MB004,D.MB072,D.MB017,B.TR021,D.MB022,D.MB066,B.TR014,D.MB041,
C.MC003,' ' Redata,C.MC002,E.MW002,D.MB090,D.MB091,B.TR015,B.TR016,B.TR028,B.TR029,
D.MB034,D.MB025,D.MB032,D.MB036,D.MB037,D.MB038,D.MB039,D.MB040,D.MB068,D.MB076,
D.MB111,D.MB148,D.MB149,B.TR002,B.TR032,D.MB443,LEVEL2=2,B.TR017,B.TR003 
,D.MB438,D.MB042 
,B.TR041 
, B.TR033,D.MB109  
FROM ATEST..Temp4_BOMTOCTO_123834178 B 
LEFT JOIN COMFORT.dbo.INVMB D (NOLOCK) ON D.MB001=B.TR009 
LEFT JOIN COMFORT.dbo.CMSMC C (NOLOCK) ON C.MC001=D.MB017 
LEFT JOIN COMFORT.dbo.CMSMW E (NOLOCK) ON E.MW001=B.TR013 
INNER JOIN ATEST..Table1_CTOBomExtract_123841402 F ON LTRIM(F.TR003)=LEFT(B.TR003,LEN(LTRIM(B.TR003))-3) AND F.TR009=B.TR004 AND B.TR009<>B.TR001 
WHERE F.LEVEL2=1
AND B.TR002='B01 W09-01黑 120行程r滑轮'
AND B.TR001='10680101'
AND (NOT (F.MB025 IN ('C') AND B.TR017='N')) 
AND ((B.TR015<='20190904' OR B.TR015='' OR B.TR015 IS NULL) 
AND (B.TR016='' OR B.TR016 IS NULL OR B.TR016>'20190904'))


DELETE FROM ATEST..Table2_CTOBomExtract_123841402


INSERT INTO ATEST..Table2_CTOBomExtract_123841402(LEVEL,MD002,MD003)  SELECT LEVEL,TR030,TR009 FROM ATEST..Table1_CTOBomExtract_123841402 WHERE LEVEL2=2 ORDER BY LEVEL,TR030


SELECT MIN(ID_NUM) ID_NUM3,LEVEL INTO ATEST..Table3_CTOBomExtract_123841402 FROM ATEST..Table2_CTOBomExtract_123841402 GROUP BY LEVEL


UPDATE ATEST..Table2_CTOBomExtract_123841402 SET NEWID=ID_NUM-B.ID_NUM3  FROM ATEST..Table2_CTOBomExtract_123841402 A,ATEST..Table3_CTOBomExtract_123841402 B  WHERE A.LEVEL=B.LEVEL


UPDATE ATEST..Table2_CTOBomExtract_123841402 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Table2_CTOBomExtract_123841402 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Table2_CTOBomExtract_123841402 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Table1_CTOBomExtract_123841402 SET LEVEL=LTRIM(A.LEVEL) + B.NEWLEVEL  
FROM ATEST..Table1_CTOBomExtract_123841402 A,ATEST..Table2_CTOBomExtract_123841402 B WHERE A.LEVEL=B.LEVEL AND A.TR030=B.MD002 AND A.TR009=B.MD003 AND A.LEVEL2=2 AND ((2=2 AND LEN(A.LEVEL)<>9) OR 2<>2 )


DROP TABLE ATEST..Table3_CTOBomExtract_123841402


INSERT INTO ATEST..Table1_CTOBomExtract_123841402( LEVEL,TR009,TR030,TR001,TR028,TR029,TR007,TR004,TR013,TR006,MB026,
MB002,MB003,MB004,MB072,MB017,TR021,MB022,MB066,TR014,MB041,
MC003,Redata,MC002,MW002,MB090,MB091,TR015,TR016,LSZCYL,LSSJYL,
MB034,MB025,MB032,MB036,MB037,MB038,MB039,MB040,MB068,MB076,
MB111,MB148,MB149,TR002,TR032,MB443,LEVEL2,TR017,TR003,MB438,MB042 
,TR041,TR033,MB109) 
SELECT F.LEVEL,B.TR009,B.TR030,B.TR001,
F.TR028*B.TR010/B.TR011/TR005, F.TR029*B.TR010*(1+B.TR012)/B.TR011/B.TR005,B.TR007,B.TR004,B.TR013,B.TR006,D.MB026,
D.MB002,D.MB003,D.MB004,D.MB072,D.MB017,B.TR021,D.MB022,D.MB066,B.TR014,D.MB041,
C.MC003,' ' Redata,C.MC002,E.MW002,D.MB090,D.MB091,B.TR015,B.TR016,B.TR028,B.TR029,
D.MB034,D.MB025,D.MB032,D.MB036,D.MB037,D.MB038,D.MB039,D.MB040,D.MB068,D.MB076,
D.MB111,D.MB148,D.MB149,B.TR002,B.TR032,D.MB443,LEVEL2=3,B.TR017,B.TR003 
,D.MB438,D.MB042 
,B.TR041 
, B.TR033,D.MB109  
FROM ATEST..Temp4_BOMTOCTO_123834178 B 
LEFT JOIN COMFORT.dbo.INVMB D (NOLOCK) ON D.MB001=B.TR009 
LEFT JOIN COMFORT.dbo.CMSMC C (NOLOCK) ON C.MC001=D.MB017 
LEFT JOIN COMFORT.dbo.CMSMW E (NOLOCK) ON E.MW001=B.TR013 
INNER JOIN ATEST..Table1_CTOBomExtract_123841402 F ON LTRIM(F.TR003)=LEFT(B.TR003,LEN(LTRIM(B.TR003))-3) AND F.TR009=B.TR004 AND B.TR009<>B.TR001 
WHERE F.LEVEL2=2
AND B.TR002='B01 W09-01黑 120行程r滑轮'
AND B.TR001='10680101'
AND (NOT (F.MB025 IN ('C') AND B.TR017='N')) 
AND ((B.TR015<='20190904' OR B.TR015='' OR B.TR015 IS NULL) 
AND (B.TR016='' OR B.TR016 IS NULL OR B.TR016>'20190904'))


DELETE FROM ATEST..Table2_CTOBomExtract_123841402


INSERT INTO ATEST..Table2_CTOBomExtract_123841402(LEVEL,MD002,MD003)  SELECT LEVEL,TR030,TR009 FROM ATEST..Table1_CTOBomExtract_123841402 WHERE LEVEL2=3 ORDER BY LEVEL,TR030


SELECT MIN(ID_NUM) ID_NUM3,LEVEL INTO ATEST..Table3_CTOBomExtract_123841402 FROM ATEST..Table2_CTOBomExtract_123841402 GROUP BY LEVEL 


UPDATE ATEST..Table2_CTOBomExtract_123841402 SET NEWID=ID_NUM-B.ID_NUM3  FROM ATEST..Table2_CTOBomExtract_123841402 A,ATEST..Table3_CTOBomExtract_123841402 B  WHERE A.LEVEL=B.LEVEL


UPDATE ATEST..Table2_CTOBomExtract_123841402 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Table2_CTOBomExtract_123841402 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Table2_CTOBomExtract_123841402 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Table1_CTOBomExtract_123841402 SET LEVEL=LTRIM(A.LEVEL) + B.NEWLEVEL  
FROM ATEST..Table1_CTOBomExtract_123841402 A,ATEST..Table2_CTOBomExtract_123841402 B WHERE A.LEVEL=B.LEVEL AND A.TR030=B.MD002 AND A.TR009=B.MD003 AND A.LEVEL2=3 AND ((3=2 AND LEN(A.LEVEL)<>9) OR 3<>2 )


DROP TABLE ATEST..Table3_CTOBomExtract_123841402


INSERT INTO ATEST..Table1_CTOBomExtract_123841402( LEVEL,TR009,TR030,TR001,TR028,TR029,TR007,TR004,TR013,TR006,MB026,
MB002,MB003,MB004,MB072,MB017,TR021,MB022,MB066,TR014,MB041,
MC003,Redata,MC002,MW002,MB090,MB091,TR015,TR016,LSZCYL,LSSJYL,
MB034,MB025,MB032,MB036,MB037,MB038,MB039,MB040,MB068,MB076,
MB111,MB148,MB149,TR002,TR032,MB443,LEVEL2,TR017,TR003,MB438,MB042 
,TR041,TR033,MB109) 
SELECT F.LEVEL,B.TR009,B.TR030,B.TR001,
F.TR028*B.TR010/B.TR011/TR005, F.TR029*B.TR010*(1+B.TR012)/B.TR011/B.TR005,B.TR007,B.TR004,B.TR013,B.TR006,D.MB026,
D.MB002,D.MB003,D.MB004,D.MB072,D.MB017,B.TR021,D.MB022,D.MB066,B.TR014,D.MB041,
C.MC003,' ' Redata,C.MC002,E.MW002,D.MB090,D.MB091,B.TR015,B.TR016,B.TR028,B.TR029,
D.MB034,D.MB025,D.MB032,D.MB036,D.MB037,D.MB038,D.MB039,D.MB040,D.MB068,D.MB076,
D.MB111,D.MB148,D.MB149,B.TR002,B.TR032,D.MB443,LEVEL2=4,B.TR017,B.TR003 
,D.MB438,D.MB042 
,B.TR041 
, B.TR033,D.MB109  
FROM ATEST..Temp4_BOMTOCTO_123834178 B 
LEFT JOIN COMFORT.dbo.INVMB D (NOLOCK) ON D.MB001=B.TR009 
LEFT JOIN COMFORT.dbo.CMSMC C (NOLOCK) ON C.MC001=D.MB017 
LEFT JOIN COMFORT.dbo.CMSMW E (NOLOCK) ON E.MW001=B.TR013 
INNER JOIN ATEST..Table1_CTOBomExtract_123841402 F ON LTRIM(F.TR003)=LEFT(B.TR003,LEN(LTRIM(B.TR003))-3) AND F.TR009=B.TR004 AND B.TR009<>B.TR001 
WHERE F.LEVEL2=3
AND B.TR002='B01 W09-01黑 120行程r滑轮'
AND B.TR001='10680101'
AND (NOT (F.MB025 IN ('C') AND B.TR017='N')) 
AND ((B.TR015<='20190904' OR B.TR015='' OR B.TR015 IS NULL) 
AND (B.TR016='' OR B.TR016 IS NULL OR B.TR016>'20190904'))


DELETE FROM ATEST..Table2_CTOBomExtract_123841402


INSERT INTO ATEST..Table2_CTOBomExtract_123841402(LEVEL,MD002,MD003)  SELECT LEVEL,TR030,TR009 FROM ATEST..Table1_CTOBomExtract_123841402 WHERE LEVEL2=4 ORDER BY LEVEL,TR030 


SELECT MIN(ID_NUM) ID_NUM3,LEVEL INTO ATEST..Table3_CTOBomExtract_123841402 FROM ATEST..Table2_CTOBomExtract_123841402 GROUP BY LEVEL


UPDATE ATEST..Table2_CTOBomExtract_123841402 SET NEWID=ID_NUM-B.ID_NUM3  FROM ATEST..Table2_CTOBomExtract_123841402 A,ATEST..Table3_CTOBomExtract_123841402 B  WHERE A.LEVEL=B.LEVEL


UPDATE ATEST..Table2_CTOBomExtract_123841402 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Table2_CTOBomExtract_123841402 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Table2_CTOBomExtract_123841402 SET NEWID=NEWID/36, NEWLEVEL=(CASE WHEN (NEWID%36)<10 THEN CHAR(ASCII('0')+NEWID % 36) ELSE CHAR(ASCII('A')+NEWID%36-10) END)+RTRIM(isnull(NEWLEVEL,''))


UPDATE ATEST..Table1_CTOBomExtract_123841402 SET LEVEL=LTRIM(A.LEVEL) + B.NEWLEVEL  
FROM ATEST..Table1_CTOBomExtract_123841402 A,ATEST..Table2_CTOBomExtract_123841402 B WHERE A.LEVEL=B.LEVEL AND A.TR030=B.MD002 AND A.TR009=B.MD003 AND A.LEVEL2=4 AND ((4=2 AND LEN(A.LEVEL)<>9) OR 4<>2 )


DROP TABLE ATEST..Table3_CTOBomExtract_123841402


INSERT INTO ATEST..Table1_CTOBomExtract_123841402( LEVEL,TR009,TR030,TR001,TR028,TR029,TR007,TR004,TR013,TR006,MB026,
MB002,MB003,MB004,MB072,MB017,TR021,MB022,MB066,TR014,MB041,
MC003,Redata,MC002,MW002,MB090,MB091,TR015,TR016,LSZCYL,LSSJYL,
MB034,MB025,MB032,MB036,MB037,MB038,MB039,MB040,MB068,MB076,
MB111,MB148,MB149,TR002,TR032,MB443,LEVEL2,TR017,TR003,MB438,MB042 
,TR041,TR033,MB109) 
SELECT F.LEVEL,B.TR009,B.TR030,B.TR001,
F.TR028*B.TR010/B.TR011/TR005, F.TR029*B.TR010*(1+B.TR012)/B.TR011/B.TR005,B.TR007,B.TR004,B.TR013,B.TR006,D.MB026,
D.MB002,D.MB003,D.MB004,D.MB072,D.MB017,B.TR021,D.MB022,D.MB066,B.TR014,D.MB041,
C.MC003,' ' Redata,C.MC002,E.MW002,D.MB090,D.MB091,B.TR015,B.TR016,B.TR028,B.TR029,
D.MB034,D.MB025,D.MB032,D.MB036,D.MB037,D.MB038,D.MB039,D.MB040,D.MB068,D.MB076,
D.MB111,D.MB148,D.MB149,B.TR002,B.TR032,D.MB443,LEVEL2=5,B.TR017,B.TR003 
,D.MB438,D.MB042 
,B.TR041 
, B.TR033,D.MB109  
FROM ATEST..Temp4_BOMTOCTO_123834178 B 
LEFT JOIN COMFORT.dbo.INVMB D (NOLOCK) ON D.MB001=B.TR009 
LEFT JOIN COMFORT.dbo.CMSMC C (NOLOCK) ON C.MC001=D.MB017 
LEFT JOIN COMFORT.dbo.CMSMW E (NOLOCK) ON E.MW001=B.TR013 
INNER JOIN ATEST..Table1_CTOBomExtract_123841402 F ON LTRIM(F.TR003)=LEFT(B.TR003,LEN(LTRIM(B.TR003))-3) AND F.TR009=B.TR004 AND B.TR009<>B.TR001 
WHERE F.LEVEL2=4
AND B.TR002='B01 W09-01黑 120行程r滑轮'
AND B.TR001='10680101'
AND (NOT (F.MB025 IN ('C') AND B.TR017='N')) 
AND ((B.TR015<='20190904' OR B.TR015='' OR B.TR015 IS NULL) 
AND (B.TR016='' OR B.TR016 IS NULL OR B.TR016>'20190904'))


DELETE ATEST..Table1_CTOBomExtract_123841402 WHERE TR009 IN (SELECT TR004 FROM ATEST..Table1_CTOBomExtract_123841402) AND LEVEL2>0

-- 清除虚设的项
DELETE FROM ATEST..Table1_CTOBomExtract_123841402 WHERE MB025 IN ('Y','C' )

-- 根据工单生产量计算物料用量
UPDATE ATEST..Table1_CTOBomExtract_123841402 SET TR028=TR028*1,TR029=TR029*1, LSZCYL=LSZCYL*1,LSSJYL=LSSJYL*1

-- 根据品号，工艺，配置方案，配置序号作 组成用量(不含损耗)， 组成用量(含损耗) 汇总
SELECT MAX(LEVEL) LEVEL,TR009,MAX(TR030) TR030,MAX(TR001) TR001,SUM(ISNULL(TR028,0)) TR028,SUM(ISNULL(TR029,0)) TR029,MAX(TR007) TR007,MAX(TR004) TR004,TR013,MAX(TR006) TR006,MAX(MB026) MB026,
MAX(MB002) MB002,MAX(MB003) MB003,MAX(MB004) MB004,MAX(MB072) MB072,MAX(MB017) MB017,MAX(TR021) TR021,MAX(MB022) MB022,MAX(MB066) MB066,ISNULL(MAX(TR014),0) TR014,ISNULL(MAX(MB041),0) MB041,
MAX(MC003) MC003,MAX(Redata) Redata,MAX(MC002) MC002,ISNULL(MAX(MW002),'') MW002,MAX(MB090) MB090,MAX(MB091) MB091,MAX(TR015) TR015,MAX(TR016) TR016,SUM(ISNULL(TR028,0)) LSZCYL,SUM(ISNULL(TR029,0)) LSSJYL,
MAX(MB034) MB034,MAX(MB025) MB025,MAX(MB032) MB032,ISNULL(MAX(MB036),0) MB036,ISNULL(MAX(MB037),0) MB037,ISNULL(MAX(MB038),0) MB038,ISNULL(MAX(MB039),0) MB039,ISNULL(MAX(MB040),0) MB040,MAX(MB068) MB068,ISNULL(MAX(MB076),0) MB076,
ISNULL(MAX(MB111),0) MB111,MAX(MB148) MB148,MAX(MB149) MB149,TR002,TR032,MAX(MB443) MB443 
,ISNULL(MAX(MB438),0) MB438,MAX(MB042) MB042 
,MAX(TR041) TR041, MAX(TR033) TR033,MAX(MB109) MB109 
FROM ATEST..Table1_CTOBomExtract_123841402 A 
GROUP BY TR009,TR013,TR002,TR032 
ORDER BY TR009,TR013




