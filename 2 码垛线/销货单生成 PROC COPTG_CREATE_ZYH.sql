ALTER PROCEDURE dbo.COPTG_CREATE_ZYH @PrintId Int, @TG001 VARCHAR(4), @TG004 VARCHAR(10), @TH007 VARCHAR(10) AS 
-- 0.此存储过程调用方式：从198作远程调用，参数：PrintId, TG001, TG004
-- 1.根据传入PrintId，连接至198.PdData获取并记录相关订单信息的客户编号、销货单别
-- 2.根据销货单别获取99上对应单别的单号生成方式（暂时不实现此功能）
-- 3.根据销货单别，获取及记录销货单号并写入到99.COPTG作销货单号在系统中占用
-- 4.根据销货单别、单号，更新固定信息的字段
-- 5.根据客户编号，更新客户信息对应的字段，获取并记录税种与税率
-- 6.根据传入的printId，连接至198.PdData获取订单号及数量，以订单号作group by
-- 7.对6获取的数据，insert进99.COPTH的相关字段
-- 8.对99.COPTH，更新固定信息字段
-- 9.对99.COPTH，更新订单信息字段
-- 10.根据税种与税率，更新99.COPTH的各种金额
-- 11.根据99.COPTH的各种金额，更新99.COPTG的各种金额与数量
-- 12.根据PrintId回写198.PrintData中的销货单信息（TG001,TG002），更新销货单生成标志位（OutFlag， OutDate）

BEGIN
	DECLARE @NY VARCHAR(6) -- 当前年月
	DECLARE @YY_SET INT, @DD_SET INT -- 销货单年月配置信息
	DECLARE @COMPANY VARCHAR(20), @CREATOR VARCHAR(20), @CREATE_DATE VARCHAR(20), @USR_GROUP VARCHAR(20) -- 创建人、公司等基本信息
	DECLARE @TG002 VARCHAR(11) -- 销货单号
	DECLARE @TG017 VARCHAR(1) -- 税种
	DECLARE @TG044 FLOAT -- 税率
	
	-- 根据传入的PrintId，从198.PdData数据关联99.COPTC，获取客户编号
-- 	SELECT TOP 1 @TG004 = RTRIM(TC004) FROM [192.168.0.198].[ROBOT_TEST].[dbo].[PdData] 
-- 	LEFT JOIN COMFORT.dbo.COPTC ON RTRIM(TC001) + '-' + RTRIM(TC002) = SUBSTRING(SC001, 1, LEN(SC001) - 5) collate chinese_prc_ci_as
-- 	WHERE 1=1 AND PrintId = @PrintId 
	
	IF (@TG004 IS NOT NULL)
	BEGIN
		-- 配置创建人员信息
		SET @CREATOR = 'DS3000'
		SET @COMPANY = 'COMFORT'
		SELECT @CREATE_DATE = REPLACE(REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR(25), GETDATE(), 21), '-', ''), ' ', ''), ':', ''), '.', '')
		SELECT @USR_GROUP = RTRIM(MF004) FROM COMFORT.dbo.ADMMF WHERE MF001 = @CREATOR
		
		-- 获取销货单号前置的年月信息
		SET @YY_SET = 2  -- 销货单 年编的位数，可以从单据设定里获取
		SET @DD_SET = 4  -- 销货单 流水号的位数，可以从单据设定里获取
		SELECT @NY = SUBSTRING(CONVERT(VARCHAR(6), GETDATE(), 112), 4 - @YY_SET + 1, 6)
		
		-- 根据TG001 获取销货单号
		IF EXISTS (SELECT * FROM COMFORT.dbo.COPTG WHERE TG002 LIKE @NY + '%' AND TG001 = @TG001)
		BEGIN
			SELECT @TG002 = RTRIM(MAX(TG002) + 1) FROM COMFORT.dbo.COPTG WHERE TG002 LIKE @NY + '%' AND TG001 = @TG001
		END
		ELSE BEGIN
			SET @TG002 = @NY + RIGHT('00000000001', @DD_SET)
		END
		
		PRINT(@TG001 + '-' + @TG002)
		
	-- 	单头占位
		INSERT INTO COMFORT.dbo.COPTG (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, FLAG, TG001, TG002, TG003, TG042) 
			VALUES(@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, 1, @TG001, @TG002, CONVERT(VARCHAR(10), GETDATE(), 112), CONVERT(VARCHAR(10), GETDATE(), 112))
		PRINT('INSERT INTO COPTG')
		
	-- 	写入单头的基本(固定)资料
		UPDATE COMFORT.dbo.COPTG SET 
			TG010 = '01', -- 出货工厂
			TG020 = '', -- 备注
			TG022 = 0, -- 打印次数
			TG023 = 'N', -- 审核码
			TG024 = 'N', -- 更新码
			TG031 = 'N', -- 烟酒注记
			TG036 = 'N', -- 生成分录(收入)
			TG037 = 'N' -- 生辰分录(成本)
			WHERE TG001 = @TG001 AND TG002 = @TG002
		PRINT('UPDATE COPTG BASIC')
		
	-- 	写入供客户信息
		UPDATE COMFORT.dbo.COPTG SET
			TG004 = MA001, -- 客户编号
			TG005 = MA015, -- 部门
			TG006 = MA016, -- 业务人员
			TG008 = MA027, -- 送货地址1
			TG009 = MA064, -- 送货地址2
			TG011 = MA014, -- 交易币种
			TG012 = MG004, -- 汇率
			TG016 = MA037, -- 发票种类
			TG017 = MA038, -- 税种
			TG026 = MA085, -- 收款业务员
			TG044 = MA101, -- 税率
			TG047 = MA083, -- 付款条件
			TG068 = MA113 -- EBC汇出码
			FROM (
				SELECT COPMAC.*, ISNULL(COPTGC.MG004, 0) AS MG004 FROM COMFORT.dbo.COPMA AS COPMAC
				LEFT JOIN(
					SELECT MA2.MA001, MA2.MA021, MG.MG002, MG.MG004 FROM COMFORT.dbo.COPMA AS MA2 
					LEFT JOIN COMFORT.dbo.CMSMG AS MG ON MG.MG001 = MA2.MA014 
						AND MG002 = (SELECT MAX(MG2.MG002) FROM CMSMG AS MG2 WHERE MG2.MG001 = MG.MG001 AND CONVERT(FLOAT, MG2.MG002) <= CONVERT(FLOAT, CONVERT(VARCHAR(8), GETDATE(), 112)))
				) AS COPTGC ON COPTGC.MA001 = COPMAC.MA001
				WHERE COPMAC.MA001 = @TG004
			) AS COPMA
			WHERE TG001 = @TG001 AND TG002 = @TG002
		PRINT('UPDATE COPTG FROM COPMA')
		
	--  7.对6获取的数据，insert进99.COPTH的相关字段	
	-- 	8.对99.COPTH，更新固定信息字段
		INSERT INTO COMFORT.dbo.COPTH (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, FLAG, TH001, TH002, TH003, TH008, TH014, TH015, TH016)
		SELECT @COMPANY AS COMPANY, @CREATOR AS CREATOR, @USR_GROUP AS USR_GROUP, @CREATE_DATE AS CREATE_DATE, 1 AS FLAG, 
		@TG001 AS TH001, @TG002 AS TH002, RIGHT('00000' + CONVERT(VARCHAR(20), ROW_NUMBER() Over (ORDER BY SC001)), 4) AS TH003, TH008, TH014, TH015, TH016
		FROM (SELECT SC001, SUBSTRING(SC001, 1, 4) AS TH014, 
		SUBSTRING(SUBSTRING(SC001, 6, LEN(SC001)), 1, CHARINDEX('-', SUBSTRING(SC001, 6, LEN(SC001))) - 1) AS TH015, 
		SUBSTRING(SUBSTRING(SC001, 6, LEN(SC001)), (CHARINDEX('-', SUBSTRING(SC001, 6, LEN(SC001))) + 1), LEN(SUBSTRING(SC001, 6, LEN(SC001)))) AS TH016, 
		COUNT(SC001) AS TH008
		FROM [192.168.0.198].ROBOT_TEST.dbo.PdData AS PdData
		WHERE PrintId = @PrintId
		AND Pd_Sta = 'OK'
		GROUP BY SC001, SUBSTRING(SC001, 1, 4), 
		SUBSTRING(SUBSTRING(SC001, 6, LEN(SC001)), 1, CHARINDEX('-', SUBSTRING(SC001, 6, LEN(SC001))) - 1), 
		SUBSTRING(SUBSTRING(SC001, 6, LEN(SC001)), (CHARINDEX('-', SUBSTRING(SC001, 6, LEN(SC001))) + 1), LEN(SUBSTRING(SC001, 6, LEN(SC001)))) 
		) AS PdData2
		PRINT('INSERT INTO COPTH')
		
	-- 	9.对99.COPTH，更新订单信息字段
		UPDATE COMFORT.dbo.COPTH SET 
			TH004 = TD004, -- 品号
			TH005 = TD005, -- 品名
			TH006 = TD006, -- 规格
			-- TH007 = TD007, -- 仓库
			TH007 = @TH007, -- 仓库
			TH009 = TD010, -- 单位
			TH012 = TD011, -- 单价
			TH017 = TH015, -- 批号
			TH018 = TD020, -- 备注
			TH019 = TD014, -- 客户品号
			TH020 = 'N', -- 审核码
			TH021 = 'N', -- 更新码
			TH025 = TD026, --折扣率
			TH026 = 'N', -- 开票码
			TH031 = '1', -- 类型
			TH048 = TD037, -- 税率
			TH049 = TD042, -- 批发价
			TH050 = TD043, -- 零售价
			TH055 = '', -- 批号说明
			TH056 = '##########', -- 仓位
			TH063 = TD061, -- 分期期别
			TH064 = TD062, -- 分期合同
			COPTH.UDF01 = COPTD.UDF01, -- PO号
			COPTH.UDF03 = TQ003, -- 描述
			COPTH.UDF04 = COPTD.UDF08, -- 保友品名
			COPTH.UDF05 = TD053, -- 配置方案
			COPTH.UDF10 = COPTD.UDF10 -- 产品电商代码
		
			FROM COMFORT.dbo.COPTH AS COPTH
			LEFT JOIN COMFORT.dbo.COPTD AS COPTD ON TH014 = TD001 AND TH015 = TD002 AND TH016 = TD003
			LEFT JOIN COMFORT.dbo.COPTQ AS COPTQ ON TQ001 = TD004 AND TQ002 = TD053
			WHERE 1=1
			AND TH001 = @TG001 AND TH002 = @TG002
		PRINT('UPDATE COPTH BASIC')
		
	-- 	10.根据税种与税率，更新99.COPTH的各种金额
		UPDATE COMFORT.dbo.COPTH SET 
			TH013 = TH013C, -- 金额
			TH035 = TH035C, -- 原币税前
			TH036 = TH036C, -- 原币税额
			TH037 = TH037C, -- 本币税前
			TH038 = TH038C -- 本币税额
			FROM (
				SELECT TG001 AS TG001C, TG002 AS TG002C, 
				(CASE 
					WHEN TG017 = '1' THEN ROUND(TH008 * TH012 * TH025, 2) 
					WHEN TG017 = '2' THEN ROUND(TH008 * TH012 * TH025, 2) 
					WHEN TG017 IN ('3', '4', '9') THEN ROUND(TH008 * TH012 * TH025, 2) END) TH013C, 
				(CASE 
					WHEN TG017 = '1' THEN ROUND(TH008 * TH012 * TH025 / (1 + TG044), 2) 
					WHEN TG017 = '2' THEN ROUND(TH008 * TH012 * TH025, 2)  
					WHEN TG017 IN ('3', '4', '9') THEN ROUND(TH008 * TH012 * TH025, 2) END) TH035C, 
				(CASE 
					WHEN TG017 = '1' THEN ROUND(TH008 * TH012 * TH025, 2) - ROUND(TH008 * TH012 * TH025 / (1 + TG044), 2) 
					WHEN TG017 = '2' THEN ROUND(TH008 * TH012 * TH025 * TG044, 2) 
					WHEN TG017 IN ('3', '4', '9') THEN 0 END) TH036C, 
				(CASE 
					WHEN TG017 = '1' THEN ROUND(ROUND(TH008 * TH012 * TH025 / (1 + TG044), 2) * TG012, 2) 
					WHEN TG017 = '2' THEN ROUND(ROUND(TH008 * TH012 * TH025, 2) * TG012, 2) 
					WHEN TG017 IN ('3', '4', '9') THEN ROUND(TH008 * TH012 * TG012 * TH025, 2) END) TH037C, 
				(CASE 
					WHEN TG017 = '1' THEN ROUND((ROUND(TH008 * TH012 * TH025, 2) - ROUND(TH008 * TH012 * TH025 / (1 + TG044), 2)) * TG012, 2) 
					WHEN TG017 = '2' THEN ROUND(TH008 * TH012 * TH025 * TG044 * TG012, 2)  
					WHEN TG017 IN ('3', '4', '9') THEN 0 END) TH038C 
				FROM COPTH 
				INNER JOIN COPTG ON TG001 = TH001 AND TG002 = TH002
				WHERE TG001 = @TG001 AND TG002 = @TG002
			) AS A0
			WHERE TH001 = TG001C AND TH002 = TG002C
		PRINT('UPDATE COPTH MONEY')
		
	-- 	11.根据99.COPTH的各种金额，更新99.COPTG的各种金额与数量
		UPDATE COMFORT.dbo.COPTG SET 
			TG033 = TG033S, -- 总数量
			TG045 = TG045S, -- 本币销货金额
			TG013 = TG013S, -- 原币销货金额
			TG046 = TG046S, -- 本币税额
			TG025 = TG025S -- 原币税额
			FROM 
			(SELECT TH001, TH002, SUM(TH008) AS TG033S, SUM(TH037) AS TG045S, SUM(TH035) AS TG013S, SUM(TH038) AS TG046S, SUM(TH036) AS TG025S FROM COMFORT.dbo.COPTH 
			WHERE TH001 = @TG001 AND TH002 = @TG002
			GROUP BY TH001, TH002
			) AS A 
			WHERE TG001 = TH001 AND TG002 = TH002
		PRINT('UPDATE COPTG MONEY')
		
	--  12.根据PrintId回写198.PrintData中的销货单信息（TG001,TG002），更新销货单生成标志位（OutFlag， OutDate）
		UPDATE [192.168.0.198].ROBOT_TEST.dbo.PrintData SET TG001 = @TG001, TG002 = @TG002, OutFlag = 1, OutDate = getdate() WHERE PrintId = @PrintId
		PRINT('UPDATE 198.PrintData')
	END
END