SELECT TR001,MB002,MB003,TR002,TR004,TR009,TR013,TR015,TR016
FROM COPTR
INNER JOIN INVMB ON MB001=TR001
INNER JOIN (SELECT TR001,TR002,TR004,TR013
FROM COPTR
GROUP BY TR001,TR002,TR004,TR013
HAVING COUNT(*)=2)  AS D ON D.
GROUP BY TR001,MB002,MB003,TR002,TR004,TR009,TR013,TR015,TR016
HAVING COUNT(*)>=2

-- 查询选配件没有勾选
SELECT TR001,TR002,TR003,TR004,TR009,TR017 FROM COPTR
WHERE 1=1
AND TR001='10910113 ' AND TR002='CI黑 8003铝脚'
AND TR004 LIKE '2400%'
-- AND TR004='24004600'

SELECT TR001,TR002,TR004,TR017 FROM COPTR
WHERE 1=1
AND TR001='10910113 ' AND TR002='CI黑 8003铝脚'
AND TR004 LIKE '24%'
-- AND TR004='24004600'
-- AND TR009 LIKE '25%'
-- AND TR017='Y'
GROUP BY TR001,TR002,TR004,TR017
HAVING COUNT(TR017)<>'1'
ORDER BY TR001,TR002

-- 查询选配件是任意件
SELECT MB001, MB002, MB003, MB025, CA013, MB109 FROM INVMB
INNER JOIN BOMCA ON MB001 = CA001 
WHERE 1=1
AND MB109 = 'Y' 
AND MB025 = 'C' AND CA013 != '1'


-- 查找出配置方案中下阶与BOM中不相等（已排除整倍重复的项）
SELECT DISTINCT RTRIM(TR001) 成品品号, RTRIM(TR002) 配置方案, RTRIM(TR004) 上阶品号, SUM(X001) 配置表中下阶项数, SUMB BOM表中下阶项数 FROM 
(
SELECT TR001, TR002, TR004, TR017, COUNT(TR017) X001 FROM COPTR
WHERE 1=1 GROUP BY TR001, TR002, TR004, TR017
) A
INNER JOIN
(
SELECT CB001, COUNT(CB005) SUMB FROM BOMCB
WHERE 1=1 GROUP BY CB001
) B ON CB001 = TR004
INNER JOIN INVMB ON MB001 = TR004 
WHERE 1=1
AND MB025 = 'C'
-- AND TR001 = '10170414'
GROUP BY TR001, TR002, TR004, SUMB
HAVING SUM(X001) <> SUMB AND SUM(X001) % SUMB <> 0
ORDER BY RTRIM(TR001), RTRIM(TR002)

-- 查找上诉中的差异（需考量配置中BOM日期以及BOM中变更日期）
SELECT RTRIM(TR001) 成品品号, RTRIM(TR002) 配置方案, RTRIM(TR004) 上阶品号, RTRIM(TR009) 配置下阶品号, 
CB004 BOM序号, RTRIM(CB005) BOM下阶品号, TR017 配置选中, TR015 配置生效日期, TR016 配置失效日期, CB013 BOM生效日期, CB014 BOM失效日期, 
TQ004 配置BOM日期, TA003 BOM项添加日期, TA005 BOM变更原因 FROM BOMCB
LEFT JOIN (
SELECT TR001, TR002, TR004, TR009, TR015, TR016, TR017 FROM COPTR 
WHERE TR001 = '10090304'
AND TR002 = 'VIL KMD灰+A灰 铝合金脚 带腰靠 全黑'
)AS A ON TR004 = CB001 AND TR009 = CB005
LEFT JOIN COPTQ ON TQ001 = TR001 AND TQ002 = TR002
LEFT JOIN(
SELECT TA003, TA005, TB004, TC004, TC005 FROM BOMTA
INNER JOIN BOMTB ON TA001 = TB001 AND TA002 = TB002
INNER JOIN BOMTC ON TB001 = TC001 AND TB002 = TC002 AND TB003 = TC003
WHERE TA007 = 'Y'
) AS B ON TB004 = CB001 AND TC004 = CB004 AND TC005 = CB005
WHERE 1=1
AND CB001 = '24000227'
ORDER BY CB004


SELECT TR001, TR002, TR003, TR004, TR009, TR017 FROM COPTR
-- UPDATE COPTR SET TR017 = 'N'
WHERE TR001 = '10090304'
AND TR002 = 'APR TW黑+A黑 耐龙椅脚 新加坡日期标'
AND TR004 = '24000227'
AND TR009 = '3010107013'
