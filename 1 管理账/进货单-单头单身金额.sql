-- PDA进货单功能，更新单头单身各类金额

-- 单身根据单价，进货数量金额
SELECT TG001, TG002, TH003, 
-- UPDATE COMFORT.dbo.PURTH  SET 
TH045 = CAST(ROUND(TH019/(1+CONVERT(FLOAT, TG030)),2) AS  NUMERIC(10,2)), 
TH046 = CAST(ROUND(TH019 - (TH019/(1+CONVERT(FLOAT, TG030))),2) AS  NUMERIC(10,2)), 
TH047 = CAST(ROUND((TH019 * CONVERT(FLOAT, TG008)/(1+CONVERT(FLOAT, TG030))),2) 
AS  NUMERIC(10,2)), 
TH048 = CAST(ROUND((TH019 * CONVERT(FLOAT, TG008)) - 
(TH019 * CONVERT(FLOAT, TG008)/(1+CONVERT(FLOAT, TG030))),2) AS  NUMERIC(10,2)) 
FROM PURTH INNER JOIN COMFORT.dbo.PURTG AS PURTG ON TG001 = TH001 AND TG002 = TH002 
WHERE 1=1
-- AND TG001= '3401' AND TG002= '19051310' -- AND TH003 = '0056'
AND TH048 = 0
AND TG014 BETWEEN '20190501' AND '20190531'

ORDER BY TG001, TG002, TH003


-- 根据单身金额，更新单头
SELECT
-- UPDATE A SET 
TG017=SUMTH019,TG019=SUMTH046,TG026=SUMTH015,TG028=SUMTH045,TG031=SUMTH047, 
TG032=SUMTH048,TG040=SUMTH050,TG041=SUMTH052,TG053=SUMTH007,TG054=SUMTH049 
FROM COMFORT.dbo.PURTG A 
INNER JOIN (SELECT TH001,TH002,SUMTH019=SUM(TH019),SUMTH046=SUM(TH046), 
SUMTH007=SUM(CASE WHEN MA024='2' THEN FLOOR(TH007) ELSE TH007 END), 
SUMTH015=SUM(CASE WHEN MA024='2' THEN FLOOR(TH015) ELSE TH015 END),SUMTH045=SUM(TH045), 
SUMTH047=SUM(TH047),SUMTH048=SUM(TH048),SUMTH050=SUM(TH050),SUMTH052=SUM(TH052), 
SUMTH049=SUM(TH049) 
FROM COMFORT.dbo.PURTH 
INNER JOIN COMFORT.dbo.CMSMA ON 1=1 
GROUP BY TH001,TH002)  AS B ON A.TG001=B.TH001 AND A.TG002=B.TH002 
WHERE TG001= '3401' AND TG002= '19054604' 
        
				
				
-- 退货单相关联单（进货、采购）据修改税率
SELECT TI001, TI002, TI007, TG001, TG002, TG030, TC001, TC002, TC026, TD033 
-- UPDATE PURTG SET TG030 = 0.13  -- 进货单头
-- UPDATE PURTC SET TC026 = 0.13  -- 采购单头
-- UPDATE PURTD SET TD033 = 0.13  -- 采购单身
FROM PURTI
INNER JOIN PURTJ ON TJ001 = TI001 AND TJ002 = TI002
INNER JOIN PURTG ON TJ013 = TG001 AND TJ014 = TG002
INNER JOIN PURTH ON TH001 = TJ013 AND TH002 = TJ014 AND TH003 = TJ015
INNER JOIN PURTC ON TJ016 = TC001 AND TJ017 = TC002
INNER JOIN PURTD ON TJ016 = TD001 AND TJ017 = TD002 AND TJ018 = TD003

WHERE TI001 = '3501' AND TI002 = '19070084'

