
-- 修改采购单单身单价
SELECT TC014, TC001, TC002, TD004, TD015 已交数量, TD008 采购数量, TD010 单价, TD011 金额, TD033 税率, TD034 税前, TD035 税额, 
-- UPDATE PURTD SET 
TD010 = CAST(dj AS NUMERIC(10, 6)), 
TD011 = CAST(ROUND(TD008 * CAST(dj AS FLOAT), 6) AS FLOAT), 
TD034 = CAST(ROUND(TD008 * CAST(dj AS FLOAT) / (1+TD033), 6) AS FLOAT),
TD035 = CAST(ROUND(TD008 * CAST(dj AS FLOAT), 6) AS FLOAT) - CAST(ROUND(TD008 * CAST(dj AS FLOAT) / (1+TD033), 6) AS FLOAT) 

FROM PURTC 
INNER JOIN PURTD ON TC001 = TD001 AND TC002 = TD002
INNER JOIN ATEST..XGDJ_20190902 AS XGDJ ON d1 = TC001 AND d2 = TC002 AND wlno = TD004
-- AND TC002 = '19071083'
ORDER BY TC001, TC002, TD004


-- 修改采购单单头金额
SELECT DISTINCT TC001, TC002, TC019 AS OTC019, TC020 AS OTC020, 
-- UPDATE PURTC SET 
TC019 = SUMTC019, TC020 = SUMTC020
FROM PURTC
INNER JOIN (
SELECT TC001 AS ATC001, TC002 AS ATC002, 
SUM(TD034) SUMTC019, SUM(TD035) SUMTC020
FROM PURTC 
INNER JOIN PURTD ON TD001 = TC001 AND TD002 = TC002
GROUP BY TC001, TC002 ) AS A ON ATC001 = TC001 AND ATC002 = TC002
INNER JOIN ATEST..XGDJ_20190902 AS XGDJ ON d1 = TC001 AND d2 = TC002
WHERE 1=1
-- AND TC004 = 'A0074'
-- AND TC001 = '3303'
-- AND TC002 = '18120020'
ORDER BY TC001, TC002
