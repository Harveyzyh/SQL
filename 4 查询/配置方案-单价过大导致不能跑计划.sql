SELECT  DISTINCT LA006 单别,LA007 单号,LA008 序号,TR020 ,LA012 单价,LA011 交易数量, LA001 品号, MB065 金额, MB064 数量, TA001, TA002, TA012, TB003, TB010, TB011,
CAST(ROUND(ABS(MB065/MB064), 4) AS NUMERIC(16, 4))
-- 更新品号信息金额
-- UPDATE INVMB SET MB065 = MB064 * LA012
-- 注释待定
-- UPDATE INVTB SET TB010 = '' -- 财务给出单价
-- 注释待定
-- UPDATE INVTB SET TB011 = TB010 * LA011
-- 注释待定
-- UPDATE INVTA SET TA012 = '' -- 总数

-- 当品号信息里的库存小于0.0001时，把库存量更新为0
-- UPDATE INVMB SET MB064 = 0

FROM COPTR
INNER JOIN INVMB ON MB001=TR009 
INNER JOIN INVLA ON LA001=MB001 
INNER JOIN INVTA ON TA001 = LA006 AND TA002 = LA007 
INNER JOIN INVTB ON TB001 = LA006 AND TB002 = LA007 AND TB003 = LA008
WHERE 1=1 
-- AND ABS(MB065/MB064)>9999 AND MB064<>0  -- 查询序号1  -- 因部分库存为0的，但数据里显示为0.000004，所以金额/数量=单价会超大
-- AND ABS(LA012)>99999 AND MB064 != 0   -- 查询序号2  -- 存在记录需打开 维护库存交易明细 根据单据把成本要素维护进去，系统会自动获取单价
-- AND TR020='N' 
-- AND TR020='Y' 
-- AND MB064 < 0.0001 AND MB064 != 0  -- 当品号信息里的库存小于0.0001时，把库存量更新为0

-- AND TR001='108203203' 
-- AND TR002='专友 CI-00+LE2095黑色 铝脚 无轮子 无APP'
AND MB064 != 0
AND SUBSTRING(LA004,1,6)>='201501'


-- 库存数量不为0 且 小于0.001
SELECT MB001, MB002, MB003, MB064, MB065 
-- UPDATE INVMB SET MB064 = 0
-- UPDATE INVMB SET MB065 = 0
FROM INVMB 
WHERE 1=1 --AND MB002 NOT IN ('口罩')
AND ((ABS(MB064) < 0.0001 AND MB064 != 0) OR ABS(MB065) > 99999999)
-- AND MB001 = '3060324001'


-- 库存数量不为0 且 小于0.001
SELECT MC001, MB002, MB003, MB004, MC007, MC008  
-- UPDATE INVMC SET MC007 = 0
-- UPDATE INVMC SET MC008 = 0
FROM INVMC 
INNER JOIN INVMB ON MB001 = MC001
WHERE 1=1 AND MB002 NOT IN ('口罩')
AND ((ABS(MC007) < 0.0001 AND MC007 != 0 ) OR ABS(MC008) > 99999999)
-- AND MC007 = 0


SELECT  DISTINCT LA004, LA001 LA品号, RTRIM(MB002) 品名, RTRIM(MB003) 规格, 
MB065 MB金额, MB064 MB数量, CAST(ROUND(ABS(MB065/MB064), 4) AS NUMERIC(16, 4)) MB单位成本, 
LA006 LA单别,LA007 LA单号,LA008 LA序号, LA012 LA单价,LA011 LA交易数量, 
TA001 TA单别, TA002 TA单号, TA012 TA总金额, TB003 TB序号, TB010 TB单位成本, TB011 TB金额 
-- 更新品号信息金额
-- UPDATE INVMB SET MB065 = MB064 * LA012
-- 注释待定
-- UPDATE INVTB SET TB010 = '' -- 财务给出单价
-- 注释待定
-- UPDATE INVTB SET TB011 = TB010 * LA011
-- 注释待定
-- UPDATE INVTA SET TA012 = '' -- 总数
-- 当品号信息里的库存小于0.0001时，把库存量更新为0
-- UPDATE INVMB SET MB064 = 0

FROM INVMB 
INNER JOIN INVLA ON LA001=MB001 
INNER JOIN INVTA ON TA001 = LA006 AND TA002 = LA007 
INNER JOIN INVTB ON TB001 = LA006 AND TB002 = LA007 AND TB003 = LA008
WHERE 1=1 AND MB002 NOT IN ('口罩')
AND ABS(MB065/MB064)>999999 AND MB064<>0  -- 查询序号1  -- 因部分库存为0的，但数据里显示为0.000004，所以金额/数量=单价会超大
-- AND ABS(LA012)>99999 AND MB064 != 0   -- 查询序号2  -- 存在记录需打开 维护库存交易明细 根据单据把成本要素维护进去，系统会自动获取单价
-- AND MB064 < 0.0001 AND MB064 != 0  -- 当品号信息里的库存小于0.0001时，把库存量更新为0
AND MB064 != 0
AND SUBSTRING(LA004,1,6)>='202003'
ORDER BY LA004, LA001, LA006, LA007, LA008


-- 修改库存交易明细，重计现有库存
SELECT LA001, MB002, LA004, LA006, LA007, LA008, LA016, LA011, LA012, LA013, LA017, TM010, CAST(TM010 * LA011 AS FLOAT) JE 
-- UPDATE INVLA SET LA012 = TM010, LA013 = CAST(TM010 * LA011 AS FLOAT), LA017 = CAST(TM010 * LA011 AS FLOAT)
FROM INVLA 
INNER JOIN INVMB ON MB001 = LA001
INNER JOIN V_GetPrice ON  TL004 = LA016 AND TM004 = LA001
WHERE 1 = 1 
AND LA004 >= '20200901'
AND LA006 IN ('1102' ,'1104')
AND (ABS(LA012) > 99999 OR LA012 < 0)
-- AND TM010 IS NOT NULL
-- AND LA001 = '3010106010'
-- AND LA007 = '20090186'
