
USE COMFORT

-- ====================================
-- 单据单头单身审核码不一致
-- 当查询不为空，涉及到库存移动的单据都需撤审重新审核
-- 因为请购单不涉及库存移动，可直接把单头审核码同步至单身审核码
-- ====================================
-- 报废单
SELECT TL001 ,TL002, TM004, TL014, TM021 FROM INVTL 
LEFT JOIN INVTM ON TM001 = TL001 AND TM002 = TL002
WHERE TL014 <> TM021

-- 领料单
SELECT TC001 ,TC002, TE004, TC009, TE019, TE012 
-- UPDATE MOCTE SET TE019 = TC009
FROM MOCTC
LEFT JOIN MOCTE ON TC001 = TE001 AND TC002 = TE002
WHERE 1=1 
AND TC009 <> TE019
AND TC009 NOT IN ( 'U', 'V')
-- AND SUBSTRING(MOCTC.CREATE_DATE, 1, 6) >= '201902'
ORDER BY TE012

-- 进货单
SELECT TG001, TG002, TH004, TG013, TH030 FROM PURTG
LEFT JOIN PURTH ON TH001 = TG001 AND TH002 = TG002
WHERE 1=1
AND TG013 <> TH030
-- AND SUBSTRING(PURTG.CREATE_DATE, 1, 6) >= '201902'

-- 请购单
SELECT TA001, TA002, TB004, TA007, TB025  
-- UPDATE PURTB SET TB025 = TA007
FROM PURTA 
INNER JOIN PURTB ON TA001 = TB001 AND TA002 = TB002
WHERE 1=1
AND TA007 <> TB025
-- AND SUBSTRING(PURTA.CREATE_DATE, 1, 6) >= '201902'
ORDER BY TA001, TA002

-- ====================================
-- 破核单据
-- 当查询不为空，在ERP的对应单据中进行撤审重新审核
-- 当领料单撤审提示工单缺领，需调整对应的单据性质，然后再撤审
-- ====================================
SELECT INF, T1, T2, T3, LA001 FROM (
SELECT DISTINCT '领料单破核' AS INF, RTRIM(MOCTC.TC001) AS T1, RTRIM(MOCTC.TC002) AS T2 , RTRIM(MOCTE.TE003) AS T3 
FROM MOCTC INNER JOIN MOCTE ON MOCTC.TC001 = MOCTE.TE001 AND MOCTC.TC002 = MOCTE.TE002 WHERE MOCTC.TC009 = 'U'
UNION 
SELECT DISTINCT '生产入库破核' AS INF, RTRIM(MOCTF.TF001) AS T1, RTRIM(MOCTF.TF002) AS T2, RTRIM(MOCTG.TG003) AS T3 
FROM MOCTF INNER JOIN MOCTG ON MOCTF.TF001 = MOCTG.TG001 AND MOCTF.TF002 = MOCTG.TG002 WHERE MOCTF.TF006 = 'U' AND SUBSTRING(MOCTF.CREATE_DATE, 1, 8) >= '20190701'
UNION 
SELECT DISTINCT '采购单破核' AS INF, RTRIM(PURTC.TC001) AS T1, RTRIM(PURTC.TC002) AS T2, RTRIM(PURTD.TD003) AS T3 
FROM PURTC INNER JOIN PURTD ON PURTC.TC001 = PURTD.TD001 AND PURTC.TC002 = PURTD.TD002 WHERE PURTC.TC014 = 'U'
UNION 
SELECT DISTINCT '进货单破核' AS INF, RTRIM(PURTG.TG001) AS T1, RTRIM(PURTG.TG002) AS T2, RTRIM(PURTH.TH003) AS T3 
FROM PURTG INNER JOIN PURTH ON PURTG.TG001 = PURTH.TH001 AND PURTG.TG002 = PURTH.TH002 WHERE PURTG.TG013 = 'U'
UNION 
SELECT DISTINCT '退货单破核' AS INF, RTRIM(PURTI.TI001) AS T1, RTRIM(PURTI.TI002) AS T2, RTRIM(PURTJ.TJ003) AS T3 
FROM PURTI INNER JOIN PURTJ ON PURTI.TI001 = PURTJ.TJ001 AND PURTI.TI002 = PURTJ.TJ002 WHERE PURTI.TI013 = 'U'
) AS A
LEFT JOIN INVLA ON T1 = LA006 AND T2 = LA007 AND T3 = LA008 
-- WHERE LA001 IS NULL


-- ====================================
-- 领料单头审单身未审
-- 出现原因：当领料单审核后，再通过辅助工具扫描然后提交后台处理后，就会出现（后台处理逻辑：先删除单身；重新填写单身；审核）
-- 解决方式：打开 工单领料单出入库明细-联查 用工单来查询，同步对应信息
-- ====================================
SELECT DISTINCT '领料单单头审单身未审' AS INF, 
RTRIM(TA001) AS 工单别, RTRIM(TA002) AS 工单号, RTRIM(TC001) AS 领料单别, RTRIM(TC002) AS 领料单号 
FROM MOCTA 
INNER JOIN MOCTB ON TA001 = TB001 AND TA002 = TB002 
INNER JOIN MOCTE ON TE011 = TA001 AND TE012 = TA002 AND TE004 = TB003 
INNER JOIN MOCTC ON TE001 = TC001 AND TE002 = TC002 
WHERE 1=1 
AND TA013 = 'Y' AND TA011 != 'y' AND TC009 != 'V' 
AND TC009 = 'Y' AND TE019 = 'N' 


-- ====================================
-- 层级码带X
-- 当查询不为空，直接执行delete
-- ====================================
SELECT DISTINCT '层级码带X' AS INF, RTRIM(TR001) AS TR001--,TR002 AS T2,TR003 AS T3,TR004 AS T4,TR009 AS T5 
-- DELETE 
FROM COPTR
WHERE TR003 like 'X%'
-- AND TR001 = '10840161'