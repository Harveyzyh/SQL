SELECT SUBSTRING(MOCTA.CREATE_DATE, 1, 8) 创建日期, TA001 工单别, TA002 工单号, TA011 状态码, TA013 审核码, TA006 品号, TA073 配置方案, 
TA015 生产数量, ME002 生产部门, TA026 订单别, TA027 订单号, TA028 序号 
-- INTO ATEST..MOCTA_BAK
FROM MOCTA 
LEFT JOIN CMSME ON ME001 = TA064
WHERE SUBSTRING(MOCTA.CREATE_DATE, 1, 8) >= '20190829' 
AND TA001 = '5101'
AND TA002 <= '19090327'
AND TA011 != 'y'
-- AND TA013 = 'N'
ORDER BY TA002



SELECT SUBSTRING(MOCTA.CREATE_DATE, 1, 8) 创建日期, TA001 工单别, TA002 工单号, TA011 状态码, TA013 审核码, TA006 品号, TA073 配置方案, 
TA015 生产数量, ME002 生产部门, TA026 订单别, TA027 订单号, TA028 序号 
-- INTO ATEST..MOCTA_BAK
FROM MOCTA 
LEFT JOIN CMSME ON ME001 = TA064
WHERE SUBSTRING(MOCTA.CREATE_DATE, 1, 8) >= '20190805' 
AND TA001 = '5101'
-- AND TA002 <= '19090327'
AND TA011 != 'y'
-- AND TA013 = 'N'
ORDER BY TA002


DECLARE @TA0 VARCHAR(20), @TA2 VARCHAR(20)

SET @TA0 = '20032925' -- 原工单
SET @TA2 = '20042224' -- 新工单

SELECT RTRIM(MB002) 品名, RTRIM(UN.TB003) 品号, RTRIM(MB003) AS 规格, RTRIM(UN.TB006) 工艺, UNA.TB004 原工单数量, UNB.TB004 新工单数量
FROM 
(
	SELECT DISTINCT TB003, TB006 FROM 
	(
		SELECT TB003, TB006 FROM MOCTB WHERE TB001 = '5101' AND TB002 = @TA0
		UNION
		SELECT TB003, TB006 FROM MOCTB WHERE TB001 = '5101' AND TB002 = @TA2
	) AS B
) AS UN
LEFT JOIN 
(
	SELECT TB003, TB006, TB004 FROM MOCTB WHERE TB001 = '5101' AND TB002 = @TA0
) AS UNA ON UNA.TB003 = UN.TB003 AND UNA.TB006 = UN.TB006
LEFT JOIN 
(
	SELECT TB003, TB006, TB004 FROM MOCTB WHERE TB001 = '5101' AND TB002 = @TA2
) AS UNB ON UNB.TB003 = UN.TB003 AND UNB.TB006 = UN.TB006

INNER JOIN INVMB ON MB001 = UN.TB003
-- WHERE (UNA.TB004 IS NULL OR UNB.TB004 IS NULL)
ORDER BY UNB.TB004, UN.TB003
