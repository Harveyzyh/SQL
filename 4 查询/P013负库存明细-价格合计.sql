SELECT RTRIM(MB001) AS 材料品号, RTRIM(MB002) AS 品名, RTRIM(MB003) AS 规格, CAST(ISNULL(INVMC.MC007, 0) AS FLOAT) AS 库存数量, RTRIM(CMSMC.MC002) AS 仓库, 
(CASE WHEN TM010 IS NULL THEN 'Y' ELSE '' END) AS 不存在单价, '' AS 价格汇总
FROM COMFORT.dbo.INVMB 
LEFT JOIN COMFORT.dbo.INVMC ON MB001 = INVMC.MC001
LEFT JOIN COMFORT.dbo.CMSMC ON CMSMC.MC001 = INVMC.MC002
LEFT JOIN (
	SELECT TOP 1 TM004, TM010 FROM V_GetPrice 
	ORDER BY TM014 DESC, TL003 DESC
) AS PRICE ON TM004 = MB001 
WHERE 1=1
AND INVMC.MC002 = 'P013'
AND ISNULL(INVMC.MC007, 0) < 0 
-- AND MB001 = '10680101'

UNION

SELECT '总计' AS 材料品号, '' AS 品名, '' AS 规格, SUM(CAST(ISNULL(INVMC.MC007, 0) AS FLOAT)) AS 库存数量, '' AS 仓库, '' AS 不存在单价, 
CAST(SUM(CASE WHEN TM010 IS NULL THEN 0 ELSE ISNULL(INVMC.MC007, 0) * TM010 END) AS VARCHAR(20)) AS 价格汇总
FROM COMFORT.dbo.INVMB 
LEFT JOIN COMFORT.dbo.INVMC ON MB001 = INVMC.MC001
LEFT JOIN COMFORT.dbo.CMSMC ON CMSMC.MC001 = INVMC.MC002
LEFT JOIN (
	SELECT TOP 1 TM004, TM010 FROM V_GetPrice 
	ORDER BY TM014 DESC, TL003 DESC
) AS PRICE ON TM004 = MB001 
WHERE 1=1
AND INVMC.MC002 = 'P013'
AND ISNULL(INVMC.MC007, 0) < 0 
-- AND MB001 = '10680101'

ORDER BY 材料品号

