-- 可使用反向查找，从最后一阶向前查找，即可，具体脚本自行编写



-- 4阶
-- 成品--裁片--面料选配--面料

-- INSERT INTO ATEST..DC10
SELECT MB1.MB001 主件品号, MB1.MB002 主件品名, MB1.MB003 主件规格,
-- MB2.MB001, MB2.MB002, CB2.CB008, CB2.CB009, CB2.CB011, 
-- MB3.MB001, MB3.MB002, CB3.CB008, CB3.CB009, CB3.CB011, 
MB9.MB001 元件品号, MB9.MB002 元件品名, MB9.MB003 元件规格, CB9.CB008 组成用量, CB9.CB009 底数, CB9.CB011 工艺编号,  

MW002 工艺名称, MB9.MB032 供应商, MA002 供应商简称
-- INTO ATEST..DC10
FROM INVMB AS MB1 
INNER JOIN BOMCB AS CB2 ON CB2.CB001 = MB1.MB001 AND (RTRIM(CB2.CB014) = '' OR CB2.CB014 IS NULL OR RTRIM(CB2.CB014) > CONVERT(VARCHAR(8), GETDATE(), 112))
INNER JOIN INVMB AS MB2 ON MB2.MB001 = CB2.CB005 AND MB2.MB109 = 'Y' AND MB2.MB002 LIKE '%裁片%'

INNER JOIN BOMCB AS CB3 ON CB3.CB001 = MB2.MB001 AND (RTRIM(CB3.CB014) = '' OR CB3.CB014 IS NULL OR RTRIM(CB3.CB014) > CONVERT(VARCHAR(8), GETDATE(), 112)) 
INNER JOIN INVMB AS MB3 ON MB3.MB001 = CB3.CB005 AND MB3.MB109 = 'Y' AND MB3.MB002 LIKE '%面料选配%'

INNER JOIN BOMCB AS CB9 ON CB9.CB001 = MB3.MB001 AND (RTRIM(CB9.CB014) = '' OR CB9.CB014 IS NULL OR RTRIM(CB9.CB014) > CONVERT(VARCHAR(8), GETDATE(), 112)) 
INNER JOIN INVMB AS MB9 ON MB9.MB001 = CB9.CB005 AND MB9.MB109 = 'Y' 

INNER JOIN CMSMW ON MW001 = CB9.CB011
INNER JOIN PURMA ON MA001 = MB9.MB032

WHERE 1=1
-- 元件筛选
AND MB9.MB001 IN (
	SELECT DISTINCT WL FROM ATEST..WL20191028
)
-- 主件筛选
-- AND MB1.MB001 = '10170439' 
AND MB1.MB001 IN (
	SELECT DISTINCT CP FROM ATEST..CP20191028
)

ORDER BY MB1.MB001, MB2.MB001, MB3.MB001, 
MB9.MB001


-- 5阶
-- 成品--覆套--裁片--面料选配--面料

-- INSERT INTO ATEST..DC10
SELECT MB1.MB001 主件品号, MB1.MB002 主件品名, MB1.MB003 主件规格,
-- MB2.MB001, MB2.MB002, CB2.CB008, CB2.CB009, CB2.CB011, 
-- MB3.MB001, MB3.MB002, CB3.CB008, CB3.CB009, CB3.CB011, 
-- MB4.MB001, MB4.MB002, CB4.CB008, CB4.CB009, CB4.CB011, 
MB9.MB001 元件品号, MB9.MB002 元件品名, MB9.MB003 元件规格, CB9.CB008 组成用量, CB9.CB009 底数, CB9.CB011 工艺编号,  

MW002 工艺名称, MB9.MB032 供应商, MA002 供应商简称
FROM INVMB AS MB1 
INNER JOIN BOMCB AS CB2 ON CB2.CB001 = MB1.MB001 AND (RTRIM(CB2.CB014) = '' OR CB2.CB014 IS NULL OR RTRIM(CB2.CB014) > CONVERT(VARCHAR(8), GETDATE(), 112))
INNER JOIN INVMB AS MB2 ON MB2.MB001 = CB2.CB005 AND MB2.MB109 = 'Y' AND MB2.MB002 LIKE '%覆套%'

INNER JOIN BOMCB AS CB3 ON CB3.CB001 = MB2.MB001 AND (RTRIM(CB3.CB014) = '' OR CB3.CB014 IS NULL OR RTRIM(CB3.CB014) > CONVERT(VARCHAR(8), GETDATE(), 112)) 
INNER JOIN INVMB AS MB3 ON MB3.MB001 = CB3.CB005 AND MB3.MB109 = 'Y' AND MB3.MB002 LIKE '%裁片%'

INNER JOIN BOMCB AS CB4 ON CB4.CB001 = MB3.MB001 AND (RTRIM(CB4.CB014) = '' OR CB4.CB014 IS NULL OR RTRIM(CB4.CB014) > CONVERT(VARCHAR(8), GETDATE(), 112)) 
INNER JOIN INVMB AS MB4 ON MB4.MB001 = CB4.CB005 AND MB4.MB109 = 'Y' AND MB4.MB002 LIKE '%面料选配%'

INNER JOIN BOMCB AS CB9 ON CB9.CB001 = MB4.MB001 AND (RTRIM(CB9.CB014) = '' OR CB9.CB014 IS NULL OR RTRIM(CB9.CB014) > CONVERT(VARCHAR(8), GETDATE(), 112)) 
INNER JOIN INVMB AS MB9 ON MB9.MB001 = CB9.CB005 AND MB9.MB109 = 'Y' 

INNER JOIN CMSMW ON MW001 = CB9.CB011
INNER JOIN PURMA ON MA001 = MB9.MB032

WHERE 1=1
-- 元件筛选
AND MB9.MB001 IN (
	SELECT DISTINCT WL FROM ATEST..WL20191028
)
-- 主件筛选
-- AND MB1.MB001 = '10170439'
AND MB1.MB001 IN (
	SELECT DISTINCT CP FROM ATEST..CP20191028
)

ORDER BY MB1.MB001, MB2.MB001, MB3.MB001, MB4.MB001, 
MB9.MB001


-- 6阶
-- 成品--覆套/组立--覆套--裁片--面料选配--面料

-- INSERT INTO ATEST..DC10
SELECT MB1.MB001 主件品号, MB1.MB002 主件品名, MB1.MB003 主件规格,
-- MB2.MB001, MB2.MB002, CB2.CB008, CB2.CB009, CB2.CB011, 
-- MB3.MB001, MB3.MB002, CB3.CB008, CB3.CB009, CB3.CB011, 
-- MB4.MB001, MB4.MB002, CB4.CB008, CB4.CB009, CB4.CB011, 

MB9.MB001 元件品号, MB9.MB002 元件品名, MB9.MB003 元件规格, CB9.CB008 组成用量, CB9.CB009 底数, CB9.CB011 工艺编号,  

MW002 工艺名称, MB9.MB032 供应商, MA002 供应商简称

FROM INVMB AS MB1 
INNER JOIN BOMCB AS CB2 ON CB2.CB001 = MB1.MB001 AND (RTRIM(CB2.CB014) = '' OR CB2.CB014 IS NULL OR RTRIM(CB2.CB014) > CONVERT(VARCHAR(8), GETDATE(), 112))
INNER JOIN INVMB AS MB2 ON MB2.MB001 = CB2.CB005 AND MB2.MB109 = 'Y' AND (MB2.MB002 LIKE '%覆套%' OR MB2.MB002 LIKE '%组立%')

INNER JOIN BOMCB AS CB3 ON CB3.CB001 = MB2.MB001 AND (RTRIM(CB3.CB014) = '' OR CB3.CB014 IS NULL OR RTRIM(CB3.CB014) > CONVERT(VARCHAR(8), GETDATE(), 112)) 
INNER JOIN INVMB AS MB3 ON MB3.MB001 = CB3.CB005 AND MB3.MB109 = 'Y' AND MB3.MB002 LIKE '%覆套%'

INNER JOIN BOMCB AS CB4 ON CB4.CB001 = MB3.MB001 AND (RTRIM(CB4.CB014) = '' OR CB4.CB014 IS NULL OR RTRIM(CB4.CB014) > CONVERT(VARCHAR(8), GETDATE(), 112)) 
INNER JOIN INVMB AS MB4 ON MB4.MB001 = CB4.CB005 AND MB4.MB109 = 'Y' AND MB4.MB002 LIKE '%裁片%'

INNER JOIN BOMCB AS CB5 ON CB5.CB001 = MB4.MB001 AND (RTRIM(CB5.CB014) = '' OR CB5.CB014 IS NULL OR RTRIM(CB5.CB014) > CONVERT(VARCHAR(8), GETDATE(), 112)) 
INNER JOIN INVMB AS MB5 ON MB5.MB001 = CB5.CB005 AND MB5.MB109 = 'Y' AND MB5.MB002 LIKE '%面料选配%'

INNER JOIN BOMCB AS CB9 ON CB9.CB001 = MB5.MB001 AND (RTRIM(CB9.CB014) = '' OR CB9.CB014 IS NULL OR RTRIM(CB9.CB014) > CONVERT(VARCHAR(8), GETDATE(), 112)) 
INNER JOIN INVMB AS MB9 ON MB9.MB001 = CB9.CB005 AND MB9.MB109 = 'Y' 

INNER JOIN CMSMW ON MW001 = CB9.CB011
INNER JOIN PURMA ON MA001 = MB9.MB032

WHERE 1=1
-- 元件筛选
AND MB9.MB001 IN (
	SELECT DISTINCT WL FROM ATEST..WL20191028
)
-- 主件筛选
-- AND MB1.MB001 = '21040023'
AND MB1.MB001 IN (
	SELECT DISTINCT CP FROM ATEST..CP20191028
)

ORDER BY MB1.MB001, MB2.MB001, MB3.MB001, MB4.MB001, MB5.MB001,
MB9.MB001