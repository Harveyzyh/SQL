--工单中存在已审的领料单，但工单中有部分所需材料不存在于关联的领料单中
SELECT 
--RTRIM(COPTD.TD001) 订单单别, RTRIM(COPTD.TD002) 订单单号, RTRIM(COPTD.TD003) 订单序号, RTRIM(COPTD.TD004) 订单品号, RTRIM(COPTD.TD005) 订单品名, RTRIM(COPTD.TD006) 订单规格, RTRIM(COPTD.TD053) 订单配置方案, 
RTRIM(TB001) 工单单别, RTRIM(TB002) 工单单号, RTRIM(ME002) 跑工单部门, RTRIM(TB003) 工单材料品号, RTRIM(MB002) 工单材料品名, RTRIM(TB006) 工单工艺编号, MW002 工单工艺名称, 
RTRIM(TB004) 工单需领用数量, RTRIM(TB005) 工单已领用数量, TB004-TB005 工单未领用数量, 
TE001 领料单别, TE002 领料单号
, '不存在领料单中' AS 状态
FROM COPTD
LEFT JOIN MOCTA ON COPTD.TD001 = TA026 AND COPTD.TD002 = TA027 AND COPTD.TD003 = TA028
LEFT JOIN MOCTB ON TA001 = TB001 AND TA002 = TB002 

LEFT JOIN MOCTE ON TE011 = TB001 AND TE012 = TB002 AND TE004 = TB003

--LEFT JOIN MOCTD ON MOCTD.TD003=TB001 AND MOCTD.TD004=TB002 AND (MOCTD.TD009=TB006 OR MOCTD.TD010=TB006 OR MOCTD.TD011=TB006 OR MOCTD.TD012=TB006)

LEFT JOIN INVMB ON MB001 = TB003
LEFT JOIN CMSME ON TA064 = ME001
LEFT JOIN CMSMW ON MW001 = TB006
WHERE 1=1
AND SUBSTRING(MOCTB.CREATE_DATE,1, 6) >= '201808'
--AND SUBSTRING(MOCTB.CREATE_DATE,1, 6) <= '201809'
AND TB004 <> '0'
AND TA011 = '2'
AND TE002 IS NULL
AND RTRIM(TB001) + '-' + RTRIM(TB002) ='5101-18091836'
ORDER BY ME002, COPTD.TD001, COPTD.TD002, COPTD.TD003, TB002, TB003


--领料单有单头没有单身
-- SELECT TC001, TC002, TE001, TE002 
-- , '领料单为空' AS INF
-- FROM MOCTC
-- LEFT JOIN MOCTE ON TC001 = TE001 AND TC002 = TE002
-- WHERE 1=1
-- AND TE002 IS NULL
-- AND TC009 <> 'V'
-- AND SUBSTRING(MOCTC.CREATE_DATE, 1, 6) >= '201805'