
-- 1.备份需要修改的权限资料，以便后续恢复 
IF EXISTS (SELECT 1 FROM sysobjects WHERE name = 'ADMMG_BAK')
DROP TABLE ADMMG_BAK

SELECT MG001 B_MG001, MG002 B_MG002, MG004 B_MG004, MG005 B_MG005, MG006 B_MG006, MG007 B_MG007, MG008 B_MG008, MG009 B_MG009 
INTO COMFORT.dbo.ADMMG_BAK
FROM COMFORT.dbo.ADMMG
WHERE 1=1  
AND MG002 IN ('MOCI03', 'MOCMI03', 'MOCI04', 'MOCMI04', 'INVI05', 'PURI09', 'PURMI09', 'PURI10', 'PURI11')

-- 2.修改对应权限的资料，审核和撤审权限都不勾选
-- UPDATE COMFORT.dbo.ADMMG SET 
MG006 = SUBSTRING(MG006, 1, 3) + 'NN' + SUBSTRING(MG006, 6, LEN(MG006)), 
MG007 = SUBSTRING(MG007, 1, 3) + 'NN' + SUBSTRING(MG007, 6, LEN(MG007)), 
MG008 = SUBSTRING(MG008, 1, 3) + 'NN' + SUBSTRING(MG008, 6, LEN(MG008))
WHERE 1=1
AND MG002 IN ('MOCI03', 'MOCMI03', 'MOCI04', 'MOCMI04', 'INVI05', 'PURI09', 'PURMI09', 'PURI10', 'PURI11')

-- 3.处理负库存单据

-- 4.查询负库存数量与金额信息
SELECT RTRIM(MB001) AS 材料品号, RTRIM(MB002) AS 品名, RTRIM(MB003) AS 规格, CAST(ISNULL(INVMC.MC007, 0) AS FLOAT) AS 库存数量, RTRIM(CMSMC.MC002) AS 仓库, 
(CASE WHEN PRICE.TM010 IS NULL THEN 'Y' ELSE '' END) AS 不存在单价, '' AS 价格汇总
FROM COMFORT.dbo.INVMB 
LEFT JOIN COMFORT.dbo.INVMC ON MB001 = INVMC.MC001
LEFT JOIN COMFORT.dbo.CMSMC ON CMSMC.MC001 = INVMC.MC002
LEFT JOIN V_GetPrice AS PRICE ON PRICE.TM004 = MB001 AND MB032 = PRICE.TL004 
WHERE 1=1
AND INVMC.MC002 = 'P013'
AND ISNULL(INVMC.MC007, 0) < 0 
UNION
SELECT '总计' AS 材料品号, '' AS 品名, '' AS 规格, SUM(CAST(ISNULL(INVMC.MC007, 0) AS FLOAT)) AS 库存数量, '' AS 仓库, '' AS 不存在单价, 
CAST(SUM(CASE WHEN PRICE.TM010 IS NULL THEN 0 ELSE ISNULL(INVMC.MC007, 0) * PRICE.TM010 END) AS VARCHAR(20)) AS 价格汇总
FROM COMFORT.dbo.INVMB 
LEFT JOIN COMFORT.dbo.INVMC ON MB001 = INVMC.MC001
LEFT JOIN COMFORT.dbo.CMSMC ON CMSMC.MC001 = INVMC.MC002
LEFT JOIN V_GetPrice AS PRICE ON PRICE.TM004 = MB001 AND MB032 = PRICE.TL004 
WHERE 1=1
AND INVMC.MC002 = 'P013'
AND ISNULL(INVMC.MC007, 0) < 0 
ORDER BY 材料品号

-- 5.还原权限信息
-- UPDATE COMFORT.dbo.ADMMG SET MG006 = B_MG006, MG007 = B_MG007, MG008 = B_MG008 
FROM COMFORT.dbo.ADMMG_BAK 
WHERE B_MG001 = MG001 AND B_MG002 = MG002 AND B_MG004 = MG004 AND B_MG005 = MG005 AND B_MG009 = MG009


