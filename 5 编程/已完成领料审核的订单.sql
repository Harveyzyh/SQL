-- 更新MOCTC的UDF08标志位
UPDATE COMFORT.dbo.MOCTC SET UDF08 = 'n' WHERE UDF08 = 'N'
GO
-- 订单信息获取
SELECT DISTINCT RTRIM(TA.TA026) TA026, RTRIM(TA.TA027) TA027
FROM COMFORT.dbo.MOCTC AS TC
INNER JOIN COMFORT.dbo.MOCTE AS TE ON TC.TC001 = TE.TE001 AND TC.TC002 = TE.TE002
INNER JOIN COMFORT.dbo.MOCTB AS TB ON TE.TE011 = TB.TB001 AND TE.TE012 = TB.TB002
INNER JOIN COMFORT.dbo.MOCTA AS TA ON TB.TB001 = TA.TA001 AND TB.TB002 = TA.TA002
WHERE 1=1
AND NOT EXISTS(
	SELECT 1 FROM COMFORT.dbo.MOCTA AS TA2
	INNER JOIN COMFORT.dbo.MOCTB AS TB2 ON TA2.TA001 = TB2.TB001 AND TA2.TA002 = TB2.TB002
	INNER JOIN COMFORT.dbo.MOCTE AS TE2 ON TE2.TE011 = TB2.TB001 AND TE2.TE012 = TB2.TB002
	INNER JOIN COMFORT.dbo.MOCTC AS TC2 ON TC2.TC001 = TE2.TE001 AND TC2.TC002 = TE2.TE002
	WHERE 1=1
	AND (TB2.TB004 - TB2.TB005 <=0 OR TC2.TC009 = 'N')
	AND TA011 NOT IN ('y', 'Y')
	AND TA.TA026 = TA2.TA026 AND TA.TA027 = TA2.TA027
)
AND TC.UDF08 = 'n'
-- AND TC.TC001 = '5406' AND TC.TC002 = '2020010134'
ORDER BY RTRIM(TA.TA026), RTRIM(TA.TA027)


-- 部门信息获取 
SELECT DISTINCT ERPID, RTRIM(MV.MV002) ERPNAME
FROM COMFORT.dbo.MOCTA AS TA
INNER JOIN COMFORT.dbo.CMSME AS ME ON ME.ME001 = TA.TA064
INNER JOIN CONFIG.dbo.ERPMSG AS ERPMSG ON ME.ME002 = ERPMSG.ERPDPT
INNER JOIN COMFORT.dbo.CMSMV AS MV ON MV.MV001 = ERPID
WHERE 1=1 
AND TA.TA026 = '2205' AND TA.TA027 = '070029'
ORDER BY ERPID

