--急单BOM订单查询

--V1.0
--生产
SELECT RTRIM(TD001) AS S1, RTRIM(TD002) AS S2, RTRIM(TD003) AS S3, RTRIM(TD004) AS S4, RTRIM(TD005) AS S5, RTRIM(TD053) AS S6, 
RTRIM(TD013) AS S7, RTRIM(TQ004) AS S8, '生产' AS S9 
FROM COPTC
LEFT JOIN COPTD ON TC001 = TD001 AND TC002 = TD002
LEFT JOIN COPTQ ON TD004 = TQ001 AND TD053 = TQ002
LEFT JOIN MOCTA ON TA026 = TD001 AND TA027 = TD002 AND TA028 = TD003
WHERE 1=1
AND SUBSTRING(COPTC.CREATE_DATE, 1, 6) >= '201805'
AND CONVERT(INT, TD013) - CONVERT(INT, TQ004) < 2
AND TD016 <> 'y'
AND TA002 IS NULL
UNION 
--采购
SELECT RTRIM(TD001) AS S1, RTRIM(TD002) AS S2, RTRIM(TD003) AS S3, RTRIM(TD004) AS S4, RTRIM(TD005) AS S5, RTRIM(TD053) AS S6, 
RTRIM(TD013) AS S7, RTRIM(TQ004) AS S8, '采购' AS S9  
FROM COPTC 
LEFT JOIN COPTD ON TC001 = TD001 AND TC002 = TD002 
LEFT JOIN COPTQ ON TD004 = TQ001 AND TD053 = TQ002 
LEFT JOIN PURTB ON TB029 = TD001 AND TB030 = TD002 AND TB031 = TD003 
LEFT JOIN COPTH ON TH014 = TD001 AND TH015 = TD002 AND TH016 = TD003 
WHERE 1=1 
AND SUBSTRING(COPTC.CREATE_DATE, 1, 6) >= '201805' 
AND CONVERT(INT, TD013) - CONVERT(INT, TQ004) < 2 
AND TD016 <> 'y' 
AND TB002 IS NULL 
AND (TH020 <> 'Y' OR TH020 IS NULL) 
ORDER BY S1, S2, S3


--V2.0
SELECT RTRIM(TD001) AS S1, RTRIM(TD002) AS S2, RTRIM(TD003) AS S3, RTRIM(TD004) AS S4, RTRIM(TD005) AS S5, RTRIM(TD053) AS S6, 
RTRIM(TD013) AS S7, RTRIM(TQ004) AS S8
FROM COPTC
LEFT JOIN COPTD ON TC001 = TD001 AND TC002 = TD002
LEFT JOIN COPTQ ON TD004 = TQ001 AND TD053 = TQ002
WHERE 1=1
AND SUBSTRING(COPTC.CREATE_DATE, 1, 14) >= '20180615000000'
AND SUBSTRING(COPTC.CREATE_DATE, 1, 14) <= '20180615120000'
AND CONVERT(INT, TD013) - CONVERT(INT, TQ004) < 2
AND TD016 <> 'y'

